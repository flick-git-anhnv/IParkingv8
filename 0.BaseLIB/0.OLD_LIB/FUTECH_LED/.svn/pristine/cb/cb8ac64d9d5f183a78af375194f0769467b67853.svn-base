using System;
using System.Collections.Generic;
using System.Text;
using System.IO.Ports;
using System.Threading;
using System.Windows.Forms;

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using Futech.Tools;

namespace Futech.Objects
{
    public class Pack
    {
        // Serial Port
        public SerialPort serialPort = null;

        // card event 
        public event CardEventHandler CardEvent;

        private Thread thread = null;
        private ManualResetEvent stopEvent = null;

        // all controller in line
        private ControllerCollection controllers = null;

        // Constructor
        public Pack()
        {

        }

        // Line ID
        private int lineID = 0;
        public int LineID
        {
            set { lineID = value; }
        }

        // delay time to receive data from reader
        private int delaytime = 500;
        public int DelayTime
        {
            get { return delaytime; }
            set { delaytime = value; }
        }

        // Controller Address
        private byte address = 0x00;
        public int Address
        {
            set { address = Convert.ToByte(ByteUntils.DecimalToBase(value, 16), 16); }
        }

        private bool isconnect = false;
        public bool IsConnect
        {
            get { return isconnect; }
            set { isconnect = value; }
        }

        // Open ComPort
        public bool CommPortOpen(string portName, int baudRate)
        {
            try
            {
                serialPort = new SerialPort();
                serialPort.PortName = portName;
                serialPort.BaudRate = baudRate;
                serialPort.ReadBufferSize = 4096;
                serialPort.WriteBufferSize = 4096;
                serialPort.DataBits = 8;
                serialPort.ReadTimeout = -1;
                serialPort.WriteTimeout = -1;
                serialPort.DtrEnable = true;
                serialPort.RtsEnable = true;
                serialPort.Open();
                IsConnect = true;
                return true;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error while opening COM Port: " + ex.Message);
            }
            IsConnect = false;
            return false;
        }

        // Close ComPort
        public bool CommPortClose()
        {
            try
            {
                if (serialPort.IsOpen)
                    serialPort.Close();
                return true;
            }
            catch
            {
                return false;
            }
        }

        // request to reader
        private void Request(byte[] buffer)
        {
            try
            {
                serialPort.Write(buffer, 0, buffer.Length);
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error while request reader: " + ex.Message);
            }
        }

        // answer from reader
        private string[] Answer()
        {
            try
            {
                string temp = null;
                while (serialPort.BytesToRead > 0)
                {
                    if (temp == null)
                        temp = ByteUntils.DecimalToBase(serialPort.ReadByte(), 16);
                    else
                        temp = temp + "|" + ByteUntils.DecimalToBase(serialPort.ReadByte(), 16);
                }
                if (temp != null)
                {
                    string[] message = temp.Split('|');
                    return message;
                }
                else
                    return null;
            }
            catch
            {
                return null;
            }
        }

        // Start
        public void PollingStart(ControllerCollection controllers)
        {
            if (thread == null)
            {
                this.controllers = controllers;
                // create events
                stopEvent = new ManualResetEvent(false);

                // start thread
                thread = new Thread(new ThreadStart(WorkerThread));
                thread.Start();
            }
        }

        // is Running
        public bool Running
        {
            get
            {
                if (thread != null)
                {
                    if (thread.Join(0) == false)
                        return true;

                    // the thread is not running, so free resources
                    Free();
                }
                return false;
            }
        }

        // Signal thread to stop work
        public void SignalToStop()
        {

            // stop thread
            if (thread != null)
            {
                // signal to stop
                stopEvent.Set();
            }
        }

        // Wait for thread stop
        public void WaitForStop()
        {
            if (thread != null)
            {
                // wait for thread stop
                thread.Join();

                Free();
            }
        }

        // Free resources
        private void Free()
        {
            thread = null;

            // release events
            stopEvent.Close();
            stopEvent = null;
        }

        // Stop
        public void PollingStop()
        {
            if (this.Running)
            {
                thread.Abort();
                WaitForStop();
            }
        }

        // Worker thread
        public void WorkerThread()
        {
            while (!stopEvent.WaitOne(0, true))
            {
                try
                {
                    if (serialPort.IsOpen)
                    {
                        foreach (Futech.Objects.Controller controller in controllers)
                        {
                            // get controller
                            // AA 02 02 00 09 4D 54 12 03
                            byte[] bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(controller.Address, 16), 16), 0x00, 0x09, 0x4D, 0x54, 0x12, 0x03 };
                            bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                            // request to reader
                            Request(bytes);
                            // wait to reply from reader
                            Thread.Sleep(delaytime);
                            // Get reply
                            string[] message = Answer();
                            if (message != null)
                            {
                                if(ByteUntils.BaseToDecimal(message[4], 16) >= 20)
                                {
                                    if (ByteUntils.BaseToDecimal(message[4], 16) == 26 && CardEvent != null)
                                    {
                                        CardEventArgs e = new CardEventArgs();
                                        e.LineID = controller.LineID;
                                        e.ControllerAddress = controller.Address;
                                        //e.CardNumber = message[19] + message[20] + message[21] + message[22] + message[23];
                                        e.CardNumber = message[19] + message[20] + message[22] + message[23];
                                        //SystemUI.SaveLogFile(e.CardNumber);
                                        e.CardNumber = Int64.Parse(e.CardNumber, System.Globalization.NumberStyles.HexNumber).ToString();
                                        e.Date = FormatDate(message[13], message[14], message[15]);
                                        e.Time = FormatTime(message[16], message[17], message[18]);

                                        // Mac dinh dau doc le la vao 1, 3,5,7. Dau doc chan la ra 2,4,6,8
                                        if (int.Parse(message[11]) % 2 == 0)
                                            e.ReaderIndex = 2;
                                        else
                                            e.ReaderIndex = 1;
                                        //e.ReaderIndex = int.Parse(message[11]);

                                        if (message[10] == "00")
                                            e.EventStatus = "Access Granted";
                                        else if (message[10] == "01")
                                            e.EventStatus = "Access Denied";
                                        else if (message[10] == "03")
                                            e.EventStatus = "Access Level Error";
                                        else if (message[11] == "04")
                                            e.EventStatus = "Time Code Error";

                                        CardEvent(this, e);
                                    }

                                    // delete card read AA 02 02 00 0C 4D 44 56 00 05 54 03                
                                    bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(controller.Address, 16), 16), 0x00, 0x0C, 0x4D, 0x44, 0x56, 0x00, 0x05, 0x54, 0x03 };
                                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                                    // request to reader
                                    Request(bytes);
                                    // wait to reply from reader
                                    Thread.Sleep(delaytime);
                                    while (serialPort.BytesToRead > 0)
                                        serialPort.ReadByte();
                                }
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    SystemUI.SaveLogFile(ex.Message);
                    //MessageBox.Show(ex.Message);
                }
            }
        }

        // Download clock
        public bool DownloadDateTime(DateTime datetime)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    // AA 02 02 00 11 53 43 14 0B 09 14 02 14 1F 1E 16 03 
                    byte hour, minute, second, day, month, year;
                    hour = Convert.ToByte(ByteUntils.DecimalToBase(datetime.Hour, 16), 16);
                    minute = Convert.ToByte(ByteUntils.DecimalToBase(datetime.Minute, 16).ToString(), 16);
                    second = Convert.ToByte(ByteUntils.DecimalToBase(datetime.Second, 16).ToString(), 16);
                    day = Convert.ToByte(ByteUntils.DecimalToBase(datetime.Day, 16).ToString(), 16);
                    month = Convert.ToByte(ByteUntils.DecimalToBase(datetime.Month, 16).ToString(), 16);
                    int y = datetime.Year - 2000;
                    year = Convert.ToByte(ByteUntils.DecimalToBase(y, 16).ToString(), 16);
                    byte dayOfWeekInNumber = (byte)DateUI.GetDayOfWeekInNumber(datetime);
                    byte[] bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x11, 0x53, 0x43, 0x14,
                    year, month,day,day,hour,minute,second,0x13, 0x03};

                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);

                    // request to reader
                    Request(bytes);
                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        return true;
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Reader Setup
        public bool ReaderSetup(int readerNo, int relayNo, int timeClose, int timeOpen, int readerType)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    // AA 02 02 00 0B 64 41 02 40 6E 03
                    // AA 02 02 00 0B 64 41 0D 40 61 03

                    byte[] bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0B, 0x64, 0x41, 
                        0x02, Convert.ToByte(ByteUntils.DecimalToBase(X2N(2,readerNo), 16), 16), 0x6E, 0x03 };
                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);
                     // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0B, 0x64, 0x41, 
                        0x0D, Convert.ToByte(ByteUntils.DecimalToBase(X2N(2,readerNo), 16), 16), 0x6E, 0x03 };
                        bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                        // request to reader
                        Request(bytes);
                        // wait to reply from reader
                        Thread.Sleep(delaytime);
                        // Get reply
                        message = Answer();
                        if (message != null)
                        {
                            //
                        }
                    }

                    // 1-8
                    //AA 02 02 00 0F 57 41 = 01 08 = 05 0A = 00 07 1A 03
                    //AA 02 02 00 11 41 50 = 01 00 00 00 00 00 00 00 03 03 

                    //5-8
                    //AA 02 02 00 0F 57 41 = 05 08 = 05 0A = 00 07 1E 03
                    //AA 02 02 00 11 41 50 = 05 00 00 00 00 00 00 00 07 03  

                    //7-8
                    //AA 02 02 00 0F 57 41 = 07 08 = 05 0A = 00 00 1B 03
                    //AA 02 02 00 11 41 50 = 07 00 00 00 00 00 00 00 05 03 

                    //AA 02 02 00 0F 57 41 = 07 08 = 05 0A = 00 07 1C 03

                    bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0F, 0x57, 0x41,
                        Convert.ToByte(ByteUntils.DecimalToBase(readerNo, 16), 16), Convert.ToByte(ByteUntils.DecimalToBase(relayNo, 16), 16), 
                        Convert.ToByte(ByteUntils.DecimalToBase(timeClose, 16), 16), Convert.ToByte(ByteUntils.DecimalToBase(timeOpen, 16), 16), 
                        0x00, Convert.ToByte(ByteUntils.DecimalToBase(readerType, 16), 16), 0x1A, 0x03};
                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);

                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    message = Answer();
                    if (message != null)
                    {
                        bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16),0x00, 0x11, 0x41, 0x50, 
                            Convert.ToByte(ByteUntils.DecimalToBase(readerNo, 16), 16), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x03 };
                        bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                        // request to reader
                        Request(bytes);

                        // wait to reply from reader
                        Thread.Sleep(delaytime);
                        // Get reply
                        message = Answer();
                        if (message != null)
                        {
                            return true;
                        }
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Open Door
        public bool OpenDoor(int relayNo)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    // AA 02 02 00 0C 72 41 03 01 00 3F 03  
                    byte[] bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0C, 0x72, 0x41,
                        Convert.ToByte(ByteUntils.DecimalToBase(relayNo, 16), 16), 0x01, 0x00, 0x3F, 0x03};
                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);
                    
                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        return true;
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Close Door
        public bool CloseDoor(int relayNo)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    // AA 02 02 00 0C 72 41 03 00 00 3E 03
                    byte[] bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0C, 0x72, 0x41,
                        Convert.ToByte(ByteUntils.DecimalToBase(relayNo, 16), 16), 0x00, 0x00, 0x3F, 0x03};
                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);

                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        return true;
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Input Setup
        public bool InputSetup(int inputNo, int pointType, int activeType, int relayNo)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    // AA 02 02 00 1B 49 53 00 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 02 03
                    byte[] bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x1B, 0x49, 0x53,
                        Convert.ToByte(ByteUntils.DecimalToBase(pointType, 16), 16), 
                        Convert.ToByte(ByteUntils.DecimalToBase(inputNo, 16), 16), 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
                        0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x03};
                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);

                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        if (activeType == 0)
                        {
                            // AA 02 02 00 0E 49 41 01 00 00 00 00 05 03
                            bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0E, 0x49, 0x41, 
                                Convert.ToByte(ByteUntils.DecimalToBase(inputNo, 16), 16), 0x00, 0x00, 0x00, 0x00, 0x05, 0x03 };
                            bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                        }
                        else if (activeType <= 2)
                        {
                            // AA 02 02 00 0E 49 41 01 02 04 00 01 02 03
                            // AA 02 02 00 0E 49 41 01 02 08 00 01 0E 03
                            bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0E, 0x49, 0x41, 
                                Convert.ToByte(ByteUntils.DecimalToBase(inputNo, 16), 16), 0x02, Convert.ToByte(ByteUntils.DecimalToBase(relayNo, 16), 16), 0x00, 0x01, 0x02, 0x03 };
                            bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                        }
                        else if (activeType <= 4)
                        {
                            // AA 02 02 00 0E 49 41 01 06 01 00 01 03 03
                            bytes = new byte[] { 0xAA, 0x02, 0x02, 0x00, 0x0E, 0x49, 0x41, 
                                Convert.ToByte(ByteUntils.DecimalToBase(inputNo, 16), 16), 0x06, 0x01, 0x00, 0x01, 0x03, 0x03 };
                            bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                        }

                        // request to reader
                        Request(bytes);

                        // wait to reply from reader
                        Thread.Sleep(delaytime);
                        // Get reply
                        message = Answer();
                        if (message != null)
                        {
                            return true;
                        }
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Download timezone
        public bool DownloadTimezone(Timezone timezone)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    // 0xAA, 0x02, 0x02, 0x00, 0x0F, 0x54, 0x41, 0x01, 0xHH, 0xmm, 0xHH, 0xmm, 0xFF, 0xCA, 0x03
                    byte[] bytes = null;
                    int timezoneID = timezone.ID + 1;
                    if (timezoneID == 1 || timezoneID == 2)
                    {

                    }
                    else
                    {
                        //bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0F, 0x43, 0x53,
                        //ByteUI.StrToBase(cardNumber.Substring(0, 2)),
                        //ByteUI.StrToBase(cardNumber.Substring(2, 2)),
                        //ByteUI.StrToBase(cardNumber.Substring(4, 2)),
                        //ByteUI.StrToBase(cardNumber.Substring(6, 2)),
                        //ByteUI.StrToBase(cardNumber.Substring(8, 2)), 0x00, 0xFF, 0xFF, 0x15, 0x00, 0x00, 0x49, 0x03};
                    }

                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);
                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        return true;
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Download card
        public bool DownloadCard(string cardNumber, string pincode, int userID, string cardMode, int timezoneID)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    timezoneID += 1;
                    byte[] bytes;
                    long cardno = Convert.ToInt64(cardNumber);
                    cardNumber = "00000000" + cardno.ToString("x");
                    cardNumber = cardNumber.Substring(cardNumber.Length - 8);
                    // AA 02 02 00 14 43 53 76 B9 00 92 07 00 FF FF 15 -> (Access Level Code) 00 00 49 03 
                    // AA 02 02 00 14 43 53 78 D1 00 4F A4 00 FF FF 15 00 00 51 03 
                    // AA 02 02 00 14 43 53 78 D1 00 4F A4 00 FF FF 16 00 00 52 03  -  Alway
                    //bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x14, 0x43, 0x53,
                    //    ByteUI.StrToBase(cardNumber.Substring(0, 2)),
                    //    ByteUI.StrToBase(cardNumber.Substring(2, 2)),
                    //    ByteUI.StrToBase(cardNumber.Substring(4, 2)),
                    //    ByteUI.StrToBase(cardNumber.Substring(6, 2)),
                    //    ByteUI.StrToBase(cardNumber.Substring(8, 2)), 0x00, 0xFF, 0xFF, 0x16, 0x00, 0x00, 0x49, 0x03};
                    bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x14, 0x43, 0x53,
                        ByteUI.StrToBase(cardNumber.Substring(0, 2)),
                        ByteUI.StrToBase(cardNumber.Substring(2, 2)),
                        0x00,
                        ByteUI.StrToBase(cardNumber.Substring(4, 2)),
                        ByteUI.StrToBase(cardNumber.Substring(6, 2)), 0x00, 0xFF, 0xFF, 0x16, 0x00, 0x00, 0x49, 0x03};

                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);
                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        return true;
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // Delete Card
        public bool DeleteCard(string cardNumber)
        {
            if (serialPort.IsOpen)
            {
                try
                {
                    byte[] bytes;
                    long cardno = Convert.ToInt64(cardNumber);
                    cardNumber = "00000000" + cardno.ToString("x");
                    cardNumber = cardNumber.Substring(cardNumber.Length - 8);
                    //  AA 02 02 00 0E 43 44 76 B9 00 92 07 51 03
                    bytes = new byte[] { 0xAA, 0x02, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x0E, 0x43, 0x44,
                        ByteUI.StrToBase(cardNumber.Substring(0, 2)),
                        ByteUI.StrToBase(cardNumber.Substring(2, 2)),
                        0x00,
                        ByteUI.StrToBase(cardNumber.Substring(4, 2)),
                        ByteUI.StrToBase(cardNumber.Substring(6, 2)), 0x51, 0x03};
                    bytes[bytes.Length - 2] = CheckSUM(bytes, 2, bytes.Length - 2);
                    // request to reader
                    Request(bytes);
                    // wait to reply from reader
                    Thread.Sleep(delaytime);
                    // Get reply
                    string[] message = Answer();
                    if (message != null)
                    {
                        return true;
                    }
                }
                catch
                {

                }
            }
            return false;
        }

        // convert from array buffer to array string
        private string[] Message(byte[] bytes, int count)
        {
            string[] message = new string[count];
            for (int i = 0; i < count; i++)
            {
                message[i] = ByteUntils.DecimalToBase(bytes[i], 16);
            }
            return message;
        }

        // Format year/month/day
        private string FormatDate(string YY, string MM, string DD)
        {
            return "20" + ByteUntils.BaseToDecimal(YY, 16).ToString("00") + "/" + ByteUntils.BaseToDecimal(MM, 16).ToString("00") + "/" + ByteUntils.BaseToDecimal(DD, 16).ToString("00");
        }

        // Format Hour:Munite:Second
        private string FormatTime(string H, string M, string S)
        {
            return ByteUntils.BaseToDecimal(H, 16).ToString("00") + ":" + ByteUntils.BaseToDecimal(M, 16).ToString("00") + ":" + ByteUntils.BaseToDecimal(S, 16).ToString("00");
        }

        // return byte_hi, & byte_low from one integer number
        // Byte[0] = byte_hi, Byte[1] = byte_low
        private byte[] Bytes(string temp1)
        {
            int temp = Convert.ToInt32(temp1);
            int hi = temp / 256;
            int low = temp % 256;
            byte[] bytes = new byte[2];
            bytes[0] = Convert.ToByte(ByteUntils.DecimalToBase(hi, 16).ToString(), 16);
            bytes[1] = Convert.ToByte(ByteUntils.DecimalToBase(low, 16).ToString(), 16);
            return bytes;
        }

        private byte CheckSUM(byte[] bytes, int start, int stop)
        {
            byte checksum = 0;
            for (int i = start; i < stop; i++)
            {
                checksum ^= bytes[i];
            }
            return checksum;
        }

        private int X2N(int X, int N)
        {
            if (N == 1)
                return 1;
            int temp = 1;
            for (int i = 0; i < N-1; i++)
            {
                temp = X * temp;
            }
            return temp;
        }
    }
}
