using Futech.Tools;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Kztek.LedController;
using System.Windows.Forms;
using Futech.DisplayLED.Model;
using System.Threading;

namespace Futech.DisplayLED
{
    internal class KztekLED : IDisplayLED
    {

        #region Properties
        private int _RowNumber = 1;
        private int _DisplayDuration = 1000;
        private string _IPAddress;
        public string IPAddress { get => _IPAddress; set => _IPAddress = value; }

        public int DisplayDuration { get => _DisplayDuration; }

        private Task Displaytask;
        private int communicationtype = 0;
        public int CommunicationType
        {
            get { return communicationtype; }
            set { communicationtype = value; }
        }
        private int address = 0;
        public int Address
        {
            get { return address; }
            set { address = value; }
        }

        public int RowNumber { get => _RowNumber; set => _RowNumber = value; }

        private Row defaultrowsetting;
        #endregion

        ILED led;
        private string LedType;
        private ScriptModel Script;
        private CancellationTokenSource tokenSource = new CancellationTokenSource();
        public KztekLED(string LedType)
        {
            this.LedType = LedType;
            Script = new ScriptModel();

        }

        public bool Connect(string comport, int baudrate)
        {
            try
            {
                _IPAddress = comport;
                led = CreateLed(this.LedType);
                if (led != null)
                {
                    //led.Connect(IPAddress);
                    led.Address = address;
                    Script.CreateDefaultScript(RowNumber, GetDefaultSetting().ToList());
                    led.Row_Settings = Script.DefaultScript.ToArray();
                    led.Set_Screen_Current(RowNumber, Script.DefaultScript.ToArray(), EM_DisplayMode.ONE_COLOR_EACH_LINE);
                    led.ErrorEvent += Led_ErrorEvent;
                    return true;
                }
                return false;
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        private void Led_ErrorEvent(object sender, ErrorEventArgs e)
        {
            SystemUI.SaveLogFile($"LED error: {e.ErrorString} at {e.FunctionName}");
        }

        public void SendToLED(string dtimein, string dtimout, string plate, string money, int cardtype, string cardstate)
        {
            try
            {
                Script.Clear();

                string cardTypeText = "Thẻ tháng";
                if (cardtype == 1)
                {
                    cardTypeText = "Xin chào";
                }

                //preprocessing data
                dtimein = String.IsNullOrEmpty(dtimein) ? String.Empty : dtimein.Remove(0, 5).Replace("/", "-"); // bo nam
                dtimout = String.IsNullOrEmpty(dtimout) ? String.Empty : dtimout.Remove(0, 5).Replace("/", "-"); // bo nam
                if (!String.IsNullOrEmpty(dtimout) && dtimout.Substring(0, 2) == dtimein.Substring(0, 2)) //vao ra trong ngay
                {
                    dtimein = dtimein.Remove(0, 6); // bo ngay thang
                    dtimout = dtimout.Remove(0, 6); // bo ngay thang
                }
                if (String.IsNullOrEmpty(dtimein) && String.IsNullOrEmpty(dtimout))  //custom script
                {
                    if (!String.IsNullOrEmpty(cardstate))
                    {
                        var r = new Row()
                        {
                            CurrentColor = EM_LedColor.RED,
                            Data = String.Empty,
                            Effect = defaultrowsetting.Effect,
                            FontSize = defaultrowsetting.FontSize,
                            Speed = defaultrowsetting.Speed,
                        };

                        Script.AddLines(GetScript(cardstate), r);
                        // Script.ModifyDefaultScript(GetScript(ConstantText.Xinmoiqua));

                        //Script.ModifyDefaultScript(GetScript(ConstantText.WelcomeLotte));
                        //if (!String.IsNullOrEmpty(money))
                        //{

                        //    Script.ModifyDefaultScript(new List<string>
                        //    {
                        //        "Khách lẻ ",
                        //        "dừng trả thẻ"
                        //    });
                        //}
                        //else
                        //{
                        //    Script.ModifyDefaultScript(new List<string>
                        //    {
                        //        "Khách lẻ ",
                        //        "dừng lấy thẻ"
                        //    });
                        //}      

                    }
                }
                else
                {
                    if (String.IsNullOrEmpty(dtimout))//su kien vao
                    {
                        Script.AddLine(plate);
                        Script.AddLine(dtimein);
                        Script.AddLine(cardTypeText);

                        //Script.AddLine(ConstantText.Xinchaoquykhach);
                        //Script.AddLine(ConstantText.Xinmoivao,EM_LedColor.GREEN);
                        //Script.AddLine(plate, EM_LedColor.RED);
                        Script.ModifyDefaultScript(GetScript("Welcome"));
                        //Script.ModifyDefaultScript(new List<string>
                        //    {
                        //        "Khách lẻ ",
                        //        "dừng lấy thẻ"
                        //    });
                    }
                    else
                    {
                        if (money != "00")
                        {
                            Script.AddLine(money);
                            Script.AddLine(cardTypeText);
                            Script.AddLine(plate);

                            //Script.AddLine(money, EM_LedColor.YELLOW);
                            //Script.AddLine(plate, EM_LedColor.RED);
                        }
                        else
                        {
                            Script.AddLine(cardTypeText);
                            Script.AddLine("Miễn phí");
                        }

                        Script.AddLine($"Vào: {dtimein}");
                        Script.AddLine($"Ra: {dtimout}");

                        /* Script.AddLine("LOTTE");
                         Script.AddLine(ConstantText.Thankyou);*/

                        /*Script.AddLine(ConstantText.iParking);
                        Script.AddLine(ConstantText.Thankyou);*/

                        //Script.AddLine($"Vào: {dtimein}", EM_LedColor.GREEN);
                        //Script.AddLine($"Ra: {dtimout}", EM_LedColor.RED);

                        Script.AddLine(ConstantText.Xinmoiqua);

                        Script.ModifyDefaultScript(GetScript(ConstantText.Xinchao));

                        //Script.ModifyDefaultScript(new List<string>
                        //    {
                        //        "Khách lẻ ",
                        //        "dừng trả thẻ"
                        //    });
                    }
                }

                if (Displaytask != null && !Displaytask.IsCompleted)
                {
                    tokenSource.Cancel();
                }
                tokenSource = new CancellationTokenSource();
                Displaytask = Display();
            }
            catch (Exception ex)
            {
               // MessageBox.Show(ex.ToString());
                throw;
            }
        }

        public void SetParkingSlot(int slotNo, byte arrow, byte color)
        {
            led.SetParkingSlot(slotNo, arrow, color);
        }

        private List<string> GetScript(string text)
        {
            var rows = text.Split('\n').ToList();
            return rows;
        }

        private ILED CreateLed(string Ledtype)
        {
            ILED obj = null;
            if (Ledtype == "P10_RED")
            {
                obj = LedFactory.GetLedController(EM_ModuleType.P10Red, _IPAddress, 100);
            }
            else if (LedType == "P10_Fullcolor")
            {
                obj = LedFactory.GetLedController(EM_ModuleType.P10FullColor, _IPAddress, 100);
            }
            else if (LedType == "P7_62_RGY")
            {
                obj = LedFactory.GetLedController(EM_ModuleType.P7_62_RGY, _IPAddress, 100);
            }
            else
            {
                obj = LedFactory.GetLedController(EM_ModuleType.LedMatrixV1_2UDP, _IPAddress, 100);
            }
            return obj;
        }

        private Row[] GetDefaultSetting()
        {
            var DefaultRowSettings = new Row[2];
            if (LedType == "P10_RED")
            {
                DefaultRowSettings[0] = new Row()
                {
                    Effect = EM_LedEffect.Stand,
                    Speed = 3,
                    FontSize = 10,
                    CurrentColor = EM_LedColor.RED,
                    Data = "Welcome",
                };
                DefaultRowSettings[1] = new Row()
                {
                    Effect = EM_LedEffect.Stand,
                    Speed = 3,
                    FontSize = 10,
                    CurrentColor = EM_LedColor.RED,
                    Data = "LOTTE"
                };
            }
            else if (LedType == "P10_Fullcolor")
            {

                DefaultRowSettings[0] = new Row()
                {
                    Effect = EM_LedEffect.Stand,
                    Speed = 3,
                    FontSize = 10,
                    CurrentColor = EM_LedColor.WHITE,
                    Data = "Xin chào"
                };
                DefaultRowSettings[1] = new Row()
                {
                    Effect = EM_LedEffect.Stand,
                    Speed = 3,
                    FontSize = 10,
                    CurrentColor = EM_LedColor.BLUE,
                    Data = ConstantText.iParking
                };
            }
            else
            {
                DefaultRowSettings[0] = new Row()
                {
                    Effect = EM_LedEffect.Stand,
                    Speed = 6,
                    FontSize = 10,
                    CurrentColor = EM_LedColor.RED,
                    Data = "Welcome"

                };
                DefaultRowSettings[1] = new Row()
                {
                    Effect = EM_LedEffect.Stand,
                    Speed = 6,
                    FontSize = 10,
                    CurrentColor = EM_LedColor.RED,
                    Data = ConstantText.iParking
                };
            }
            defaultrowsetting = DefaultRowSettings[0];
            return DefaultRowSettings;
        }

        public void Close()
        {
            try
            {

            }
            catch (Exception ex)
            {
                SystemUI.SaveLogFile("Close:" + ex.Message);
            }
        }

        private Task Display()
        {
            var task = Task.Run(async () =>
            {
                CancellationToken CancellationToken = tokenSource.Token;
                if (Script != null && led != null)
                {
                    for (int i = 0; i < Script.Length; i += RowNumber)
                    {
                        if (i + RowNumber <= Script.Length)
                        {
                            if (!CancellationToken.IsCancellationRequested)
                            {
                                led.Set_Screen_Current(RowNumber, Script.CurrentScript.GetRange(i, RowNumber).ToArray(), EM_DisplayMode.ONE_COLOR_EACH_LINE);
                            }
                        }
                        await Task.Delay(DisplayDuration, CancellationToken);
                        if (i < Script.Length && (i + RowNumber) > Script.Length) //dòng lẻ (led 2 dòng, script dài 5 => lẻ 1)
                        {
                            foreach (var l in Script.CurrentScript.GetRange(i, Script.Length - i - 1))
                            {
                                if (!CancellationToken.IsCancellationRequested)
                                {
                                    led.Set_Screen_Current(l.Data, EM_DisplayMode.ONE_COLOR_EACH_LINE);
                                }
                            }
                        }
                    }
                    await Task.Delay(2000, CancellationToken);
                    if (!CancellationToken.IsCancellationRequested)
                    {
                        led.Set_Screen_Current(RowNumber, Script.DefaultScript.ToArray(), EM_DisplayMode.ONE_COLOR_EACH_LINE);
                    }
                    //led.Set_Screen_Current(Scripts[i]?.Text ?? "");
                }
            });
            return task;
        }
    }
}
