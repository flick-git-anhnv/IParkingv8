using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using RawInput_dll;

namespace Futech.Objects
{
    public partial class USBProximitySettingPage : Form, IControllerSettingPage
    {
        //public USBProximitySettingPage()
        //{
        //    InitializeComponent();
        //}

        public event CardEventHandler CardEvent;
        public event InputEventHandler InputEvent;

        private readonly RawInput _rawinput;
        const bool CaptureOnlyInForeground = false;

        public string CardNumber { get; set; } = "";

        private DateTime lastKeystroke = new DateTime(0);
        private List<char> barcode = new List<char>();

        public USBProximitySettingPage()
        {
            InitializeComponent();
            try
            {
                _rawinput = new RawInput(Handle, CaptureOnlyInForeground);
                // _rawinput.AddMessageFilter();   // Adding a message filter will cause keypresses to be handled           
                //Win32.DeviceAudit();              
                _rawinput.KeyPressed += OnKeyPressed;

                isconnect = true;
            }
            catch
            {
                isconnect = false;
            }
        }

        // Line ID
        public int LineID
        {
            set { }
        }

        // Controller Address
        public int Address
        {
            set { }
        }

        private int controllerTypeID = 0;
        public int ControllerTypeID
        {
            set { controllerTypeID = value; }
        }

        private int communicationType = 0;
        public int CommunicationType
        {
            set { communicationType = value; }
        }

        private bool isconnect = false;
        public bool IsConnect
        {
            get { return isconnect; }
            set { isconnect = value; }
        }

        // Delay time property
        public int DelayTime
        {
            set { }
        }

        private int downloadTime = 1500;
        public int DownloadTime
        {
            set
            {
                downloadTime = value;
            }
        }

        // all controller in line
        private ControllerCollection controllers = new ControllerCollection();
        public ControllerCollection Controllers
        {
            set { controllers = value; }
        }

        // all timezones
        private TimezoneCollection timezones = new TimezoneCollection();
        public TimezoneCollection Timezones
        {
            set
            {
                timezones = value;
            }
        }

        // all controllerTypes
        private ControllerTypeCollection controllerTypes = new ControllerTypeCollection();
        public ControllerTypeCollection ControllerTypes
        {
            set { controllerTypes = value; }
        }

        // all blackLists
        private BlackListCollection blackLists = new BlackListCollection();
        public BlackListCollection BlackLists
        {
            get { return blackLists; }
            set { blackLists = value; }
        }

        private string Comport = "";
        private int Baudrate = 9600;

       // private string Comport2 = "";

        public bool Connect(string comPort, int baudRate)
        {
           
            this.Comport = comPort;
            this.Baudrate = baudRate;

            return true;//usbMifare.Connect(comPort, (short)baudRate, communicationType);
        }

        public bool DisConnect()
        {
            return true;//usbMifare.Disconnect();
        }

        internal void OnKeyPressed(object sender, RawInputEventArg e)
        {

            if (AcceptDevice(e.KeyPressEvent.DeviceName, this.Comport) == true)
            {
                _rawinput.AddMessageFilter();
            }
            else
            {
                _rawinput.RemoveMessageFilter();

            }

            if (e.KeyPressEvent.KeyPressState == "MAKE")
            {

              
                TimeSpan elapsed = (DateTime.Now - lastKeystroke);

                if (elapsed.TotalMilliseconds > 100)
                    barcode.Clear();

                // record keystroke & timestamp
                barcode.Add((char)e.KeyPressEvent.VKey);
                lastKeystroke = DateTime.Now;

                // process barcode
                if (e.KeyPressEvent.VKey == 13 && barcode.Count >= 6)
                {
                    string msg = new String(barcode.ToArray());
                    barcode.Clear();

                    foreach (Controller controller in controllers)
                    {
                       // if (e.KeyPressEvent.DeviceName.Replace("#", "").ToLower().Contains(controller.Description.Replace("\\", "").ToLower()))
                        if(e.KeyPressEvent.DeviceName.ToUpper().Contains(controller.Description.ToUpper()))
                        {
                            CardEventArgs ce = new CardEventArgs();
                            ce.LineID = controller.LineID;
                            ce.LineCode = controller.LineCode;
                            ce.ControllerAddress = controller.Address;
                            ce.Date = DateTime.Now.ToString("yyyy/MM/dd");
                            ce.Time = DateTime.Now.ToString("HH:mm:ss");
                            ce.ReaderIndex = 1;
                            string cardnumber = "";
                            string cardnumberH = long.Parse(msg).ToString("X");
                            while (cardnumberH.Length < 6)
                                cardnumberH = "0" + cardnumberH;
                            if (cardnumberH.Length > 6)
                                cardnumberH = cardnumberH.Substring(cardnumberH.Length - 6, 6);
                            cardnumber = int.Parse(cardnumberH.Substring(0, 2), System.Globalization.NumberStyles.HexNumber).ToString("000") + int.Parse(cardnumberH.Substring(2, 4), System.Globalization.NumberStyles.HexNumber).ToString("00000");
                            ce.CardNumber = cardnumber;

                            ce.Message = controller.Description;//; e.KeyPressEvent.DeviceName;

                            CardEvent(this, ce);
                        }
                    }
                }

            }
        }

        private bool AcceptDevice(string devicename, string comport)
        {
            try
            {
                //02273219
                //if (devicename.ToUpper().Contains("HID"))//&&devicename.Contains(comport))
                //    return true;
                string[] st = comport.Split(new char[] { ';' }, StringSplitOptions.RemoveEmptyEntries);
                if (st != null && st.Length > 0)
                {
                    for (int i = 0; i < st.Length; i++)
                    {
                        if (devicename.ToLower().Contains(st[i].ToLower()) == true)
                            return true;
                    }
                }
            }
            catch
            { }
            return false;
        }

        // Start Polling
        public void PollingStart()
        {

        }

        void sc100_InputEvent(object sender, InputEventArgs e)
        {
            //throw new Exception("The method or operation is not implemented.");
            if (InputEvent != null)
            {
                InputEvent(this, e);
            }
        }

        // Signal to Stop
        public void SignalToStop()
        {
            //usbMifare.SignalToStop();
        }

        // Stop Polling
        public void PollingStop()
        {
            //_rawinput.KeyPressed -= OnKeyPressed;

        }

        private void sc100_CardEvent(object sender, CardEventArgs e)
        {
            //if (CardEvent != null)
            //{
            //    CardEvent(this, e);
            //}
        }

        public bool DownloadCard(Employee employee, int timezoneID, int memoryID)
        {

            return true;// sc100.DownloadCard(employee.CardNumber, employee.Passwords, memoryID, "01", timezoneID);
        }

        public bool DeleteCard(Employee employee, int memoryID)
        {

            return true;// sc100.DeleteCard(memoryID);
        }

        public string GetFinger(string cardNumber, int fingerID)
        {
            return "";
        }

        public bool Unlock(int delay)
        {

            return true;
        }

        public bool Unlock2(int outputNo, int delay)
        {

            return true;
        }

        // Test connection
        public bool TestConnection()
        {
            return IsConnect;
        }

        private void SC100SettingPage_Load(object sender, EventArgs e)
        {
            PollingStop();


        }

        private void SC100SettingPage_FormClosing(object sender, FormClosingEventArgs e)
        {
            PollingStart();
        }

        private void btnClose_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        // DateTime Download
        private void btnDateTimeDownload_Click(object sender, EventArgs e)
        {

        }

        // DateTime Upload
        private void btnDateTimeUpload_Click(object sender, EventArgs e)
        {

        }

        // Set KeyA
        private void btnWriteKeyA_Click(object sender, EventArgs e)
        {

        }

        // Recover Record
        private void btnRecoverRecord_Click(object sender, EventArgs e)
        {

        }

        private void btnLoad_Click(object sender, EventArgs e)
        {

        }

        private void btnSave_Click(object sender, EventArgs e)
        {
            //sc100.Address = Address;

        }

        private void btnGetVersion_Click(object sender, EventArgs e)
        {

        }

        private void btnAddToBlackList_Click(object sender, EventArgs e)
        {

        }

        private void btnRemoveFromBlackList_Click(object sender, EventArgs e)
        {

        }

        private void btnReadBlackList_Click(object sender, EventArgs e)
        {

        }

        private void btnWriteBlackList_Click(object sender, EventArgs e)
        {

        }

        private void btnClearBalckList_Click(object sender, EventArgs e)
        {

        }

        private void lsbBlackList_SelectedIndexChanged(object sender, EventArgs e)
        {

        }

        private void btnOpenDoor_Click(object sender, EventArgs e)
        {

        }

        public void DelAllEvent()
        {

        }
    }
}
