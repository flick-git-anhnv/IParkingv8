using System;
using System.Net;
using System.Collections.Generic;
using System.Text;
using System.Xml;
using System.IO;
using System.Security.Permissions;
using Microsoft.Win32;
using System.Windows.Forms;
using System.Globalization;
using SecureDongle;
using System.Threading.Tasks;
using System.Drawing;
using System.Reflection;

namespace Futech.Tools
{
    public enum LogType
    {
        Error,
        Info,
        Warning
    }

    public static class SystemUI
    {
        public static string programName = "";
        private static readonly log4net.ILog log = log4net.LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);
        // Updates a key within the App.config
        public static void UpdateKey(string keys, string values)
        {
            try
            {
                XmlDocument xmlDoc = new XmlDocument();
                xmlDoc.Load(Application.StartupPath + @"\" + programName + ".exe.config");
                XmlNode appSettingsNode = xmlDoc.SelectSingleNode("configuration/appSettings");

                // Attempt to locate the requested setting.
                foreach (XmlNode childNode in appSettingsNode)
                {
                    if (childNode.Attributes["key"].Value == keys)
                    {
                        childNode.Attributes["value"].Value = values;
                    }
                }
                xmlDoc.Save(Application.StartupPath + @"\" + programName + ".exe.config");
                xmlDoc.Save(AppDomain.CurrentDomain.SetupInformation.ConfigurationFile);
            }
            catch (Exception ex)
            {
                MessageBox.Show("An error occur while update App.config: " + ex.Message);
            }
        }

        public static string dateSeparator = "/";
        public static string shortDateFormat = "MM/dd/yyyy";
        public static string timeSeparator = ":";
        public static string timeFormat = "HH:mm:ss";
        public static string decimalSymbol = ".";
        public static string thousandSymbol = ",";
        
        public static void LoadCurrentSystemSettings()
        {
            try
            {
                RegistryKey key = Registry.CurrentUser.OpenSubKey(@"Control Panel\International", true);
                dateSeparator = key.GetValue("sDate").ToString();
                shortDateFormat = key.GetValue("sShortDate").ToString();
                timeSeparator = key.GetValue("sTime").ToString();
                timeFormat = key.GetValue("sTimeFormat").ToString();
                decimalSymbol = key.GetValue("sDecimal").ToString();
                thousandSymbol = key.GetValue("sThousand").ToString();
                key.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("An error occur while load system settings: " + ex.Message);
            }
        }

        public static void SaveCurrentSystemSetting()
        {
            try
            {
                RegistryKey key = Registry.CurrentUser.OpenSubKey(@"Control Panel\International", true);
                key.SetValue("sDate", dateSeparator);
                key.SetValue("sShortDate", shortDateFormat);
                key.SetValue("sTime", timeSeparator);
                key.SetValue("sTimeFormat", timeFormat);
                key.SetValue("sDecimal", decimalSymbol);
                key.SetValue("sThousand", thousandSymbol);
                key.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("An error occur while save system setting file: " + ex.Message);
            }
        }

        public static void SaveStandardSystemSetting()
        {
            try
            {
                RegistryKey key = Registry.CurrentUser.OpenSubKey(@"Control Panel\International", true);
                key.SetValue("sDate", "/");
                key.SetValue("sShortDate", "MM/dd/yyyy");
                key.SetValue("sTime", ":");
                key.SetValue("sTimeFormat", "HH:mm:ss");
                key.SetValue("sDecimal", ".");
                key.SetValue("sThousand", ",");
                key.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("An error occur while save system setting file: " + ex.Message);
            }
        }

        // remove unicode character in string
        public static string RemoveUnicode(string s)
        {
            string stFormD = s.Normalize(NormalizationForm.FormD);
            StringBuilder sb = new StringBuilder();

            for (int ich = 0; ich < stFormD.Length; ich++)
            {
                UnicodeCategory uc = CharUnicodeInfo.GetUnicodeCategory(stFormD[ich]);
                if (uc != UnicodeCategory.NonSpacingMark)
                {
                    sb.Append(stFormD[ich]);
                }
            }
            return (sb.ToString().Normalize(NormalizationForm.FormC));
        }
        public static void SaveLogFile(string Message)
        {
            log.Error(Message);
        }
        /// <summary>
        /// Lưu log file sử dụng Log4net
        /// </summary>
        /// <param name="Message"></param>
        //public static void SaveLogFile(string Message, LogType Type = LogType.Error)
        //{
        //    if(Type == LogType.Error)
        //    {
        //        log.Error(Message);
        //    }
        //    else if(Type == LogType.Info)
        //    {
        //        log.Info(Message);
        //    }
        //    else
        //    {
        //        log.Warn(Message);
        //    }
        //}

        // Dia chi may tinh
        public static string LocalIPAddress()
        {
            try
            {
                IPHostEntry host;
                string localIP = "";
                host = Dns.GetHostEntry(Dns.GetHostName());
                foreach (IPAddress ip in host.AddressList)
                {
                    if (ip.AddressFamily.ToString() == "InterNetwork")
                    {
                        localIP = ip.ToString();
                    }
                }
                return localIP;
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        public enum LoopEventType
        {
            INVALID_PLATE=0,
            PLATE_LOCK,
            INACCESSABLE,
            VEHICLE_GOT_IN,
            VEHICLE_NOT_GET_IN,
            LOOP_DAY,
            LOOP_MONTH,
            ESCAPE_IN,
            ESCAPE_OUT,
            BLACKLIST

        }

        public enum CardEventType
        {
            INVALID_CARD=0,
            CARD_LOCK,
            INACCESSABLE,
            VEHICLE_GOT_IN,
            CARD_EXPIRE,
            CARD_DAY,
            CARD_MONTH,
            VEHICLE_NOT_GET_IN,
            BLACKLIST
           
        }

        public enum AlarmType
        {
            INVALID_CARD = 1,
            CARD_LOCK = 2,
            INACCESSABLE = 3,
            VEHICLE_GOT_IN = 4,
            VEHICLE_NOT_GET_IN = 5,
            OPEN_BARRIE_BY_PC = 6,
            OPEN_BARRIE_BY_BUTTON = 7,
            ESCAPE_EVENT_IN = 8,
            ESCAPE_EVENT_OUT = 9,
            CARD_EXPIRED = 10,
            INVALID_PLATE = 11,
            BLACKLIST = 12,
            PLATE_LOCK = 13,
            PLATE_EXPIRE = 14,
            CARDGROUP_LOCK = 15,
            PLATE_NOT_SAME = 16,
            VEHICLE_ON_LOOP = 17,
            VALID_OPEN_BARRIE_BY_PC = 18,
            VALID_OPEN_BARRIE_BY_BUTTON = 19,
            WRITE_IN = 20,
            WRITE_OUT = 21,
            WRONG_VEHICLE_TYPE = 22,
            FACE_NOT_DETECTED = 23,
            FACE_STRANGER = 24,
            FACE_WRONG_PLATE = 25,
            Camera_Take_Image_False = 26,
            Camera_Disconnect = 27,
            Database_Disconnected = 28,
            Database_Save_In_False = 29,
            Database_Save_Out_False = 30,
            Save_Pic_False = 31
        }

        public static string[] ListAlarmCode = new string[]
        {
            "001:Không xác định được thẻ",
            "002:Thẻ bị khóa",
            "003:Sai quyền truy cập",          
            "004:Xe đã vào bãi",
            "005:Xe chưa vào bãi",         
            "006:Mở barrie bằng máy tính",
            "007:Mở barrie bằng nút ấn",
            "008:Sự kiện escape vào",
            "009:Sự kiện escape ra",
            "010:Thẻ hết hạn sử dụng",
            "011:Biển số không hợp lệ",
            "012:Danh sách đen",
            "013:Biển số bị khóa",
            "014:Biển số hết hạn sử dụng",
            "015:Nhóm thẻ bị khóa",
            "016:Biển số không khớp",
            "017:Xe đè vòng từ",
            "018:Mở barrier bằng máy tính (hợp lệ)",
            "019:Mở barrier bằng nút nhấn (hợp lệ)",
            "020:Ghi vé vào",
            "021:Ghi vé ra",
            "022:Khác loại phương tiện đăng ký",
        };

        enum SDCmd : ushort
        {
            SD_FIND = 1,//Find Dongle
            SD_FIND_NEXT = 2,//Find Next Dongle
            SD_OPEN = 3,//Open Dongle
            SD_CLOSE = 4,//Close Dongle
            SD_READ = 5,//Read Dongle
            SD_WRITE = 6,//Write Dongle
            SD_RANDOM = 7,//Generate Random Number
            SD_SEED = 8,//Generate Seed Code
            SD_WRITE_USERID = 9,//Write User ID
            SD_READ_USERID = 10,//Read User ID
            SD_SET_MODULE = 11,//Set Module
            SD_CHECK_MODULE = 12,//Check Module
            SD_WRITE_ARITHMETIC = 13,//Write Arithmetic
            SD_CALCULATE1 = 14,//Calculate 1
            SD_CALCULATE2 = 15,//Calculate 2
            SD_CALCULATE3 = 16,//Calculate 3
            SD_DECREASE = 17,//Decrease Module Unit
            SD_SET_COUNTER = 20,//set counter
            SD_GET_COUNTER = 21,//get counter
            SD_DEC_COUNTER = 22,
            SD_SET_TIMER = 23,//set timer
            SD_GET_TIMER = 24,//get timer
            SD_ADJUST_TIMER = 25,//adjust timer
            SD_SET_RSAKEY_N = 29,//write RSA N
            SD_SET_RSAKEY_D = 30,//write RSA D
            SD_UPDATE_GEN_HEADER = 31,//generate encrypted file header
            SD_UPDATE_GEN = 32,//create encrypted file content
            SD_UPDATE_CHECK = 33,//update cipher file
            SD_UPDATE = 34,//update cipher file
            SD_SET_DES_KEY = 41,//Set DES key
            SD_DES_ENC = 42,//DES encryption
            SD_DES_DEC = 43,//DES decryption
            SD_RSA_ENC = 44,//RSA encryption
            SD_RSA_DEC = 45,//RSA decryption
            SD_READ_EX = 46,//read dongle memory
            SD_WRITE_EX = 47,//write dongle memory
            SD_SET_COUNTER_EX = 0xA0,//set counter value type changed from WORD to DWORD
            SD_GET_COUNTER_EX = 0xA1,//get counter, value type changed from WORD to DWORD
            SD_SET_TIMER_EX = 0xA2,//set timer time value type changed from WORD to DWORD
            SD_GET_TIMER_EX = 0xA3,//get timer time value type changed from WORD to DWORD
            SD_ADJUST_TIMER_EX = 0xA4,//adjust timer, time value type changed from WORD to DWORD
            SD_UPDATE_GEN_HEADER_EX = 0xA5,//generate update file header specialize in updating RSA key pair
            SD_UPDATE_GEN_EX = 0xA6,//generate update file content specialize in updating RSA key pair
            SD_UPDATE_CHECK_EX = 0xA7,//update file checking specialize in updating RSA key pair
            SD_UPDATE_EX = 0xA8,//update cipher file specialize in updating RSA key pair
            SD_SET_UPDATE_KEY = 0xA9,//set update RSA key pair
            SD_ADD_UPDATE_HEADER = 0xAA,//fill head of authorization file
            SD_ADD_UPDATE_CONTENT = 0xAB,//fill content of authorization file
            SD_GET_TIME_DWORD = 0xAC,//get value(DWORD type) based on 2006.1.1.0.0.0
            SD_VERSION = 100,//get COS Version
        };

        enum SDErrCode : uint
        {
            ERR_SUCCESS = 0,							//No error
            ERR_NO_PARALLEL_PORT = 0x80300001,		//(0x80300001)No parallel port
            ERR_NO_DRIVER,							//(0x80300002)No drive
            ERR_NO_DONGLE,							//(0x80300003)No SecureDongle
            ERR_INVALID_pWORD,					//(0x80300004)Invalid pword
            ERR_INVALID_pWORD_OR_ID,				//(0x80300005)Invalid pword or ID
            ERR_SETID,								//(0x80300006)Set id error
            ERR_INVALID_ADDR_OR_SIZE,				//(0x80300007)Invalid address or size
            ERR_UNKNOWN_COMMAND,					//(0x80300008)Unkown command
            ERR_NOTBELEVEL3,						//(0x80300009)Inner error
            ERR_READ,								//(0x8030000A)Read error
            ERR_WRITE,								//(0x8030000B)Write error
            ERR_RANDOM,								//(0x8030000C)Generate random error
            ERR_SEED,								//(0x8030000D)Generate seed error
            ERR_CALCULATE,							//(0x8030000E)Calculate error
            ERR_NO_OPEN,							//(0x8030000F)The SecureDongle is not opened
            ERR_OPEN_OVERFLOW,						//(0x80300010)Open SecureDongle too more(>16)
            ERR_NOMORE,								//(0x80300011)No more SecureDongle
            ERR_NEED_FIND,							//(0x80300012)Need Find before FindNext
            ERR_DECREASE,							//(0x80300013)Dcrease error
            ERR_AR_BADCOMMAND,						//(0x80300014)Band command
            ERR_AR_UNKNOWN_OPCODE,					//(0x80300015)Unkown op code
            ERR_AR_WRONGBEGIN,						//(0x80300016)There could not be constant in first instruction in arithmetic 
            ERR_AR_WRONG_END,						//(0x80300017)There could not be constant in last instruction in arithmetic 
            ERR_AR_VALUEOVERFLOW,					//(0x80300018)The constant in arithmetic overflow
            ERR_UNKNOWN = 0x8030ffff,					//(0x8030FFFF)Unkown error

            ERR_RECEIVE_NULL = 0x80300100,			//(0x80300100)Receive null
            ERR_PRNPORT_BUSY = 0x80300101				//(0x80300101)Parallel port busy

        };

        public static bool CheckHardKey()
        {
            try
            {
                SecureDonglecom SD = new SecureDonglecom();

                //Declare variable
                byte[] buffer = new byte[1024];
                object obbuffer = new object();
                ushort handle = 0;
                ushort p1 = 0;
                ushort p2 = 0;
                ushort p3 = 0;
                ushort p4 = 0;
                uint lp1 = 0;
                uint lp2 = 0;
                ulong ret = 1;


                p1 = 0x40B0;
                p2 = 0x8D28;
                p3 = 0xE602;     //advance password. Must set to 0 for end user application
                p4 = 0x2D29;     //advance password. Must set to 0 for end user application

                ret = SD.SecureDongle((ushort)SDCmd.SD_FIND, ref handle, ref lp1, ref lp2, ref p1, ref p2, ref p3, ref p4, ref obbuffer);

                if (ret != 0)
                {

                    return false;
                }
                else
                    return true;

            }
            catch
            {
            }
            return false;
        }

        public static Bitmap CropImage(Bitmap source, Rectangle section)
        {
            var bitmap = new Bitmap(section.Width, section.Height);
            using (var g = Graphics.FromImage(bitmap))
            {
                g.DrawImage(source, 0, 0, section, GraphicsUnit.Pixel);
                return bitmap;
            }
        }

        public static string RemoveUseLess(string st)
        {
            for (int i = st.Length - 1; i >= 0; i--)
            {
                char ch = char.ToUpper(st[i]);
                if ((ch < 'A' || ch > 'Z') && (ch < '0' || ch > '9'))
                {
                    st = st.Remove(i, 1);
                }
            }
            return st;
        }

        public static void ToggleDoubleBuffered<TControl>(this TControl control, bool isOn) where TControl : Control
        {
            PropertyInfo pi = control.GetType().GetProperty("DoubleBuffered",
            BindingFlags.Instance | BindingFlags.NonPublic);
            pi.SetValue(control, isOn, null);
        }
    }
}
