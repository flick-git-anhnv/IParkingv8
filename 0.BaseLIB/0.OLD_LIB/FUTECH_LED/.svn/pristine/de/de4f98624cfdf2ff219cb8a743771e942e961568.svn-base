using System;
using System.Collections.Generic;
using System.Text;
using System.Windows.Forms;
using System.Net;
using System.Net.Sockets;
using System.Net.NetworkInformation;
using System.IO.Ports;
using Futech.Tools;

namespace Futech.DisplayLED
{
    internal class FUTECH2LINE:IDisplayLED
    {
         private System.IO.Ports.SerialPort port = new System.IO.Ports.SerialPort();
        private int _RowNumber = 1;

        public int RowNumber { get => _RowNumber; set => _RowNumber = value; }
        Socket UdpServer;
        //UdpClient udp;
        IPEndPoint ipEpBroadcast;

        private int communicationtype = 0;
        public int CommunicationType
        {
            get { return communicationtype; }
            set { communicationtype = value; }
        }

        private int address = 0;
        public int Address
        {
            get { return address; }
            set { address = value; }
        }

        private Timer timer = new Timer();
        //CTO
        public FUTECH2LINE()
        {
            timer.Enabled = false;
            timer.Interval = 1000;
            timer.Tick += new EventHandler(timer_Tick);
        }

        private string Comport = "";
        int Baudrate = 100;

        public bool Connect(string comport, int baudrate)
        {
            try
            {
                if (comport.Contains("COM") == true)
                {
                    communicationtype = 0;
                    port.PortName = comport;
                    port.BaudRate = baudrate;
                    port.ReadBufferSize = 4096;
                    port.WriteBufferSize = 4096;
                    port.DataBits = 8;
                    port.ReadTimeout = -1;
                    port.WriteTimeout = -1;
                    port.DtrEnable = true;
                    port.RtsEnable = true;
                    port.InitializeLifetimeService();
                    port.Open();
                    return true;
                }
                else
                {
                    CommunicationType = 1;
                    this.Comport = comport;
                    this.Baudrate = baudrate;
                    UdpServer = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);

                    ipEpBroadcast = new IPEndPoint(IPAddress.Parse(comport), baudrate);

                    UdpServer.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.Broadcast, 1);
                    return true;

                }

               
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        int count = 0;
        void timer_Tick(object sender, EventArgs e)
        {
            //throw new NotImplementedException();
            count++;
            if (count > 20)
            {
                count = 0;
                RunMessage();
                timer.Stop();
            }
        }

        public void SendToLED(string dtimein, string dtimout, string plate, string money, int cardtype, string cardstate)
        {
            try
            {
                if (CommunicationType == 0)
                {
                    byte[] temp = new byte[40];
                    temp[0] = 0x01;//header
                    temp[1] = Convert.ToByte(ByteUI.Asc(address.ToString("000")[0]));//add1
                    temp[2] = Convert.ToByte(ByteUI.Asc(address.ToString("000")[1]));//add2
                    temp[3] = Convert.ToByte(ByteUI.Asc(address.ToString("000")[2]));//add3

                    byte ctrl = 0x31;//control
                    if (cardtype == 0)//month
                        ctrl = 0x32;
                    else if (cardtype == 2)//vip
                        ctrl = 0x33;
                    else// if (cardtype == 1)//day
                        ctrl = 0x31;

                    temp[4] = ctrl;

                    //if (ctrl == 0x31)//day
                    {

                        money = int.Parse(money.Replace(",", "").Replace(".", "")).ToString("00000000");

                        for (int i = 0; i < 8; i++)
                            temp[i + 5] = Convert.ToByte(ByteUI.Asc(money[i]));

                        for (int i = 13; i < 40; i++)
                            temp[i] = 0x30;

                        //time in

                        if (dtimein != "")
                        {
                            string _timein = DateTime.Parse(dtimein).ToString("MMddHHmm");
                            for (int i = 0; i < 8; i++)
                            {
                                temp[13 + i] = Convert.ToByte(ByteUI.Asc(_timein[i]));
                            }
                        }

                        if (dtimout != "")
                        {
                            string _timeout = DateTime.Parse(dtimout).ToString("MMddHHmm");
                            for (int i = 0; i < 8; i++)
                            {
                                temp[21 + i] = Convert.ToByte(_timeout[i]);
                            }
                        }
                    }

                    string _plate = plate.Replace("-", "").Replace(".", "");
                    //_plate = "2346";
                    int k = 0;
                    while (_plate.Length < 10)
                    {
                        if (k % 2 == 0)
                            _plate = _plate + " ";
                        else
                            _plate = " " + _plate;
                        k = k + 1;
                    }
                    for (int i = 0; i < 10; i++)
                    {
                        temp[29 + i] = Convert.ToByte(ByteUI.Asc(_plate.Substring(i, 1)));
                    }
                   
                    temp[39] = ByteUI.CRC(temp, 40, 1);

                    if (port.IsOpen)
                    {
                        port.Write(temp, 0, temp.Length);
                    }


                }
                else if (CommunicationType == 1)
                {
                    //UdpServer = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);

                    //ipEpBroadcast = new IPEndPoint(IPAddress.Parse(this.Comport), this.Baudrate);

                    //UdpServer.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.Broadcast, 1);

                    byte[] temp = new byte[40];

                    temp[0] = 0x01;//header
                    temp[1] = Convert.ToByte(ByteUI.Asc(address.ToString("000")[0]));//add1
                    temp[2] = Convert.ToByte(ByteUI.Asc(address.ToString("000")[1]));//add2
                    temp[3] = Convert.ToByte(ByteUI.Asc(address.ToString("000")[2]));//add3

                    byte ctrl = 0x31;//control
                    if (cardtype == 0)//month
                        ctrl = 0x32;
                    else if (cardtype == 2)//vip
                        ctrl = 0x33;
                    else// if (cardtype == 1)//day
                        ctrl = 0x31;

                    temp[4] = ctrl;

                    //if (ctrl == 0x31)//day
                    {

                        money = int.Parse(money.Replace(",", "").Replace(".","")).ToString("00000000");

                        for (int i = 0; i < 8; i++)
                            temp[i + 5] = Convert.ToByte(ByteUI.Asc(money[i]));

                        for (int i = 13; i < 40; i++)
                            temp[i] = 0x30;

                        //time in

                        if (dtimein != "")
                        {
                            string _timein = DateTime.Parse(dtimein).ToString("MMddHHmm");
                            for (int i = 0; i < 8; i++)
                            {
                                temp[13 + i] = Convert.ToByte(ByteUI.Asc(_timein[i]));
                            }
                        }

                        if (dtimout != "")
                        {
                            string _timeout = DateTime.Parse(dtimout).ToString("MMddHHmm");
                            for (int i = 0; i < 8; i++)
                            {
                                temp[21 + i] = Convert.ToByte(_timeout[i]);
                            }
                        }
                    }

                    string _plate = plate.Replace("-", "").Replace(".", "");
                    //_plate = "2346";
                    int k = 0;
                    while (_plate.Length < 10)
                    {
                        if (k % 2 == 0)
                            _plate = _plate + " ";
                        else
                            _plate = " " + _plate;
                        k = k + 1;
                    }
                    for (int i = 0; i < 10; i++)
                    {
                        temp[29 + i] = Convert.ToByte(ByteUI.Asc(_plate.Substring(i, 1)));
                    }

                    temp[39] = ByteUI.CRC(temp, 40, 1);

                    UdpServer.SendTo(temp, ipEpBroadcast);
                    System.Threading.Thread.Sleep(700);
                    UdpServer.SendTo(temp, ipEpBroadcast);
                    //System.Threading.Thread.Sleep(700);
                    //UdpServer.SendTo(temp, ipEpBroadcast);
                    // UdpServer.SendTo(temp, ipEpBroadcast);
                }
            }
            catch (Exception ex)
            {
                SystemUI.SaveLogFile("SendToLED:" + ex.Message);
            }
        }

        public byte[] ByteToSend(string address, byte ctrl, DateTime dtin, DateTime dtout, string money)
        {
            try
            {
                byte[] temp = new byte[40];
                //temp[0]-temp[3] VAO:
                temp[0] = Convert.ToByte(ByteUI.Asc("V"));
                temp[1] = Convert.ToByte(ByteUI.Asc("A"));
                temp[2] = Convert.ToByte(ByteUI.Asc("O"));
                temp[3] = Convert.ToByte(ByteUI.Asc("-"));
                //thoi gian vao
                string sdtin = dtin.ToString("HH:mm dd/MM/yyyy");
                for (int i = 0; i < sdtin.Length; i++)
                {
                    temp[4 + i] = Convert.ToByte(ByteUI.Asc(sdtin[i].ToString()));
                }
                temp[20] = Convert.ToByte(ByteUI.Asc("R"));
                temp[21] = Convert.ToByte(ByteUI.Asc("A"));
                temp[22] = Convert.ToByte(ByteUI.Asc(" "));
                temp[23] = Convert.ToByte(ByteUI.Asc("-"));
                //thoi gian ra
                string sdtout = dtout.ToString("HH:mm");
                for (int i = 0; i < sdtout.Length; i++)
                {
                    temp[24 + i] = Convert.ToByte(ByteUI.Asc(sdtout[i].ToString()));
                }
                temp[29] = Convert.ToByte(ByteUI.Asc(" "));
                //so tien
                //money = string.Format("{0:0,0}", Convert.ToInt32(money));
                if (money.Length < 10)
                {
                    int n = 40 - money.Length;
                    for (int i = 30; i < n; i++)
                    {
                        temp[i] = Convert.ToByte(ByteUI.Asc(" "));
                    }
                    for (int i = 0; i < money.Length; i++)
                    {
                        temp[n + i] = Convert.ToByte(ByteUI.Asc(money[i].ToString()));
                    }
                }
                else
                {
                    money = money.Substring(0, 10);
                    for (int i = 0; i < 10; i++)
                    {
                        temp[30 + i] = Convert.ToByte(ByteUI.Asc(money[i].ToString()));
                    }
                }
                return temp;
            }
            catch
            {
                return null;
            }

        }
        public byte[] ByteToSend(string address, byte ctrl, string str)
        {
            try
            {
                byte[] temp = new byte[40];
                if (str.Length > 20)
                    str = str.Substring(0, 20);
                int n = (20 - str.Length) / 2;
                //space
                for (int i = 0; i < n; i++)
                {
                    temp[i] = Convert.ToByte(ByteUI.Asc(" "));
                }
                //string
                for (int i = 0; i < str.Length; i++)
                {
                    temp[n + i] = Convert.ToByte(ByteUI.Asc(str[i]));
                }
                //space
                for (int i = n + str.Length; i < 20; i++)
                {
                    temp[i] = Convert.ToByte(ByteUI.Asc(" "));
                }
                //20 byte hang duoi
                for (int i = 20; i < 40; i++)
                {
                    temp[i] = Convert.ToByte(ByteUI.Asc(" "));
                }
                return temp;
            }
            catch
            {
                return null;
            }

        }

        private void Delete()
        {
            try
            {
                byte[] buff = new byte[] { 0x0C };
                if (port.IsOpen)
                {
                    port.Write(buff, 0, buff.Length);
                }
            }
            catch
            { }

        }
        private void RunMessage()
        {
            try
            {
                Delete();
                byte[] buff = new byte[] { 0x04, 0x01, 0x44, 0x31, 0x31, 0x17 };
                if (port.IsOpen)
                {
                    port.Write(buff, 0, buff.Length);
                }
            }
            catch
            { }
        }
        public void SetParkingSlot(int slotNo, byte arrow, byte color)
        {

        }
        public void Close()
        {
            try
            {
                if (communicationtype == 0)
                    port.Close();
                else
                {
                    UdpServer.Close();
                }
            }
            catch (Exception ex)
            {
                SystemUI.SaveLogFile("Close:" + ex.Message);
            }
        }
    }
}
