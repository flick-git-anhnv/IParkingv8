using System;
using System.Windows.Forms;

namespace Futech.Objects.Ingress
{
    public partial class IngressSettingPage : Form, IControllerSettingPage
    {
        #region: Properties
        //--Private
        private IngressTask ingress = new IngressTask();
        private int controllerTypeID = 0;
        private int communicationType = 0;
        private bool _isconnect = false;
        private int downloadTime = 5;
        private ControllerCollection controllers = new ControllerCollection();
        private ControllerTypeCollection controllerTypes = new ControllerTypeCollection();
        private TimezoneCollection timezones = new TimezoneCollection();
        private bool isHaveStopRequest = false;

        //--Public
        public bool IsReadingEvent()
        {
            return ingress.IsReadingEvent;
        }
        public int LineID
        {

            set { ingress.LineID = value.ToString(); }
        }
        public int Address
        {
            set { ingress.Address = value; }
        }
        public int ControllerTypeID
        {
            set { controllerTypeID = value; }
        }
        public int CommunicationType
        {
            set { communicationType = value; }
        }
        public bool IsConnect
        {
            get { return ingress.IsConnect; }
            set { _isconnect = value; }
        }
        public int DelayTime
        {
            set { ingress.DelayTime = value; }
        }
        public int DownloadTime
        {
            set { downloadTime = value; }
        }
        public ControllerCollection Controllers
        {
            set { controllers = value; }
        }
        public ControllerTypeCollection ControllerTypes
        {
            set { controllerTypes = value; }
        }
        public TimezoneCollection Timezones
        {
            set
            {
                timezones = value;
            }
        }
        public bool IsHaveStopRequest { set { ingress.IsStopGetEvent = value; } }

        public BlackListCollection BlackLists { get; set; }

        //--Event
        public event CardEventHandler CardEvent;
        public event InputEventHandler InputEvent;
        public event ErrorEventHandler ErrorEvent;
        #endregion: End Properties

        #region: Forms
        public IngressSettingPage()
        {
            InitializeComponent();
            ingress.InputEvent += Ingress_InputEvent;
        }
        private void IngressusSettingPage_Load(object sender, EventArgs e)
        {
            PollingStop();
        }

        private void IngressusSettingPage_FormClosing(object sender, FormClosingEventArgs e)
        {
            PollingStart();
        }
        #endregion: End Forms

        #region: Public Function

        #region: Connect
        public bool Connect(string ip, int port)
        {
            if (communicationType == 0)
            {
                return false;
            }
            else if (communicationType == 1)
            {
                bool a = ingress == null;
                bool isConnectSuccess = ingress.Connect(ip, port, communicationType);
                return isConnectSuccess;
            }
            return false;
        }
        public bool DisConnect()
        {
            if (communicationType == 0)
            {
                return false;
            }
            else if (communicationType == 1)
            {
                return ingress.DisConnect();
            }
            return false;
        }
        public bool TestConnection()
        {
            return false;
        }
        #endregion: End Connect



        #region Relay
        public bool SetRelayDelayTime(int delay)
        {
            return ingress.Unlock(1);
        }
        public bool Open(int outputNo, int delay)
        {
            return ingress.Unlock(outputNo);
        }

        #endregion: End Relay

        #endregion: End Public Function

        #region: Event
        public void PollingStart()
        {
            if (!isHaveStopRequest)
            {
                ingress.CardEvent += new CardEventHandler(ingress_CardEvent);
                ingress.PollingStart(controllers);
            }
            else
            {
                ingress.PollingStop();
            }
        }
        public void SignalToStop()
        {
            PollingStop();
        }
        public void PollingStop()
        {
            ingress.PollingStop();
            ingress.CardEvent -= new CardEventHandler(ingress_CardEvent);
        }

        private void Ingress_InputEvent(object sender, InputEventArgs e)
        {
            if (InputEvent != null)
                InputEvent(this, e);
        }
        void ingress_CardEvent(object sender, CardEventArgs e)
        {
            if (CardEvent != null)
                CardEvent(this, e);
        }

        #endregion: End Event


        public bool DownloadCard(Employee employee, int timezoneID, int memoryID)
        {
            return true;
        }

        public bool DeleteCard(Employee employee, int memoryID)
        {
            return true;
        }

        public string GetFinger(string cardNumber, int fingerID)
        {
            return "";
        }

        public bool Unlock(int delay)
        {
            ingress.OpenDOor();
            return true;
        }

        public bool Unlock2(int outputNo, int delay)
        {
            ingress.OpenDOor();
            return true;
        }

        public void DelAllEvent()
        {
        }

        public string GetInputState()
        {
            return "";
        }
    }
}