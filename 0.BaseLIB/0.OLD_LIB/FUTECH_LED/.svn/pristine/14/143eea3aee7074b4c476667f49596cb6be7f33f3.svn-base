using System;
using System.Collections.Generic;
using System.Text;
using System.Drawing;
using System.Configuration;
using System.Windows.Forms;

namespace Futech.LPR
{
    public class LPREngine
    {

        // Constructor
        public LPREngine()
        {
            
        }

        private ILPR ilpr = null;
        public ILPR Ilpr
        {
            get { return ilpr; }
        }

        // Default: 0, false, false, 30, 25, false, 64, 8, 0, 0, 1000, 0, 0, 0
        public void LoadSetting()
        {
            // Get the current configuration file.
            System.Configuration.Configuration config = ConfigurationManager.OpenExeConfiguration(Application.ExecutablePath);
            KeyValueConfigurationCollection appSettings = config.AppSettings.Settings;

            // ContrastLevel = 2; 0-Unknown, 1-Low, 2-Medium, 3-High,  ~ Medium
            if (appSettings["ContrastLevel"] == null)
                appSettings.Add("ContrastLevel", "2");
            else
                ilpr.ContrastLevel = Convert.ToInt32(appSettings["ContrastLevel"].Value.ToString());

            // Deinterlace = false;
            if (appSettings["Deinterlace"] == null)
                appSettings.Add("Deinterlace", "false");
            else
                ilpr.Deinterlace = Convert.ToBoolean(appSettings["Deinterlace"].Value.ToString());

            // DeinterlacedSource = false;
            if (appSettings["DeinterlacedSource"] == null)
                appSettings.Add("DeinterlacedSource", "false");
            else
                ilpr.DeinterlacedSource = Convert.ToBoolean(appSettings["DeinterlacedSource"].Value.ToString());

            // DeviationAnge = 30;
            if (appSettings["DeviationAnge"] == null)
                appSettings.Add("DeviationAnge", "30");
            else
                ilpr.DeviationAnge = Convert.ToInt32(appSettings["DeviationAnge"].Value.ToString());

            // Fps = 25; Only Video Mode
            if (appSettings["Fps"] == null)
                appSettings.Add("Fps", "25");
            else
                ilpr.Fps = Convert.ToInt32(appSettings["Fps"].Value.ToString());

            // HistogramEquualization = false;
            if (appSettings["HistogramEquualization"] == null)
                appSettings.Add("HistogramEquualization", "false");
            else
                ilpr.HistogramEquualization = Convert.ToBoolean(appSettings["HistogramEquualization"].Value.ToString());

            // MaxCharHeight = 64;
            if (appSettings["MaxCharHeight"] == null)
                appSettings.Add("MaxCharHeight", "120");
            else
                ilpr.MaxCharHeight = Convert.ToInt32(appSettings["MaxCharHeight"].Value.ToString());

            // MinCharHeight = 8;
            if (appSettings["MinCharHeight"] == null)
                appSettings.Add("MinCharHeight", "8");
            else
                ilpr.MinCharHeight = Convert.ToInt32(appSettings["MinCharHeight"].Value.ToString());

            // MotionDetectionTriggering = 0;
            if (appSettings["MotionDetectionTriggering"] == null)
                appSettings.Add("MotionDetectionTriggering", "0");
            else
                ilpr.MotionDetectionTriggering = Convert.ToInt32(appSettings["MotionDetectionTriggering"].Value.ToString());

            // PlateColorSchema = 1; 0-Unknown, 1-BlackOnWhite, 2-WhiteOnBlack, 3-All ~ BlackOnWhite
            if (appSettings["PlateColorSchema"] == null)
                appSettings.Add("PlateColorSchema", "1");
            else
                ilpr.PlateColorSchema = Convert.ToInt32(appSettings["PlateColorSchema"].Value.ToString());

            // PlatePresenceTime = 1000;
            if (appSettings["PlatePresenceTime"] == null)
                appSettings.Add("PlatePresenceTime", "1000");
            else
                ilpr.PlatePresenceTime = Convert.ToInt32(appSettings["PlatePresenceTime"].Value.ToString());

            // PreciseMode = 0; Normal, Mode1, Mode2, Night ~ Normal
            if (appSettings["PreciseMode"] == null)
                appSettings.Add("PreciseMode", "0");
            else
                ilpr.PreciseMode = Convert.ToInt32(appSettings["PreciseMode"].Value.ToString());

            // RotateAngle = 0;
            if (appSettings["RotateAngle"] == null)
                appSettings.Add("RotateAngle", "0");
            else
                ilpr.RotateAngle = Convert.ToInt32(appSettings["RotateAngle"].Value.ToString());

            config.Save(ConfigurationSaveMode.Minimal, true);
            //foreach (KeyValueConfigurationElement appSetting in config.AppSettings.Settings)
            //    MessageBox.Show(appSetting.Key + ":" + appSetting.Value);
        }

        public void Setting()
        {
            frmSetting frm = new frmSetting(ilpr);
            if (frm.ShowDialog() == System.Windows.Forms.DialogResult.OK)
            {
                LoadSetting();
            }
        }

        // LPR VN
        public static string[] LoadLPRVN()
        {
            return new string[] {
                "11",
                "12",
                "14",
                "15", "16", // Hai Phong
                "17",
                "18",
                "19",
                "20",
                "21",
                "22",
                "23",
                "24",
                "25",
                "26",
                "27",
                "28",
                "29", "30", "31", "32", // Ha Noi
                "33",
                "34",
                "35",
                "36",
                "37",
                "38",
                "43",
                "47",
                "48",
                "49",
                "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", // HCM
                "60",
                "61",
                "62",
                "63",
                "64",
                "65",
                "66",
                "67",
                "68",
                "69", 
                "70",
                "71",
                "72",
                "73",
                "74",
                "75",
                "76",
                "77",
                "78",
                "79",
                "80",
                "81",
                "82",
                "83",
                "84",
                "85",
                "86",
                "88",
                "89",
                "90",
                "92", // Quang Nam
                "93",
                "94",
                "95",
                "97",
                "98",
                "99",
                "AT", // Binh doan 12
                "AD", // Quan doan 4, Binh doan Cuu Long
                "BB", // Bo binh
                "BC", // Binh chung Cong binh
                "BH", // Binh chung hoa hoc
                "BS", // Binh doan Truong Son
                "BT", // Binh chung thong tin lien lac
                "BP", // Bo tu lenh bien phong
                "HB", // Hocj vien Luc Quan
                "HH", // Hocj vien Quan Y
                "KA", // Quan khu 1
                "KB", // Quan khu 2
                "KC", // Quan khu 3
                "KD", // Quan khu 4
                "KV", // Quan khu 5
                "KP", // Quan khu 7
                "KK", // Quan khu 9
                "PP", // Cac quan ly vien
                "QH", // Quan chung Hai quan
                "QK", "QP", // Quan chung phong khong khong quan
                "TC", // Tong cuc chinh tri
                "TH", // Tong cuc hau can
                "TK", // Tong cuc cong nghiep quoc phong
                "TT", // Tong cuc ky thuat
                "TM", // Bo tong tham muu
                "VT", // Viettel
                "NG", // Ngoai giao
                "NN" // To chuc, ca nhan nuoc ngoai
            };

        }

        public static string[] LoadEngineList()
        {
            return new string[] { "DTKLPR", "FutechLPR", "FutechLPR2" };
        }

        public void Init(bool bVideo, string provider) // True ~ Video Mode, False ~ Still Image
        {
            switch (provider)
            {
                case "DTKLPR":
                    ilpr = new DTKLPR();
                    break;
                case "FutechLPR":
                    //ilpr = new FutechLPR();
                    //break;
                case "FutechLPR2":
                    ilpr = new FutechLPR2();
                    break;
                case "KztekLPR":
                    ilpr = new KztekLPR();
                    break;
                case "KztekLPR2":
                    ilpr = new KztekLPR2();
                    break;

            }
            if (ilpr != null)
            {
                ilpr.Init(bVideo);
                LoadSetting();
            }
        }

        public void Dispose()
        {
            ilpr.Dispose();
        }

        public void ReadFromBitmap(int hBmp, int customData)
        {
            ilpr.ReadFromBitmap(hBmp, customData);
        }

        public LicensePlateCollection ReadFromBitmap(Bitmap bitmap, int customData, ref int recognitionTime, ref LicensePlate bestLicensePlate)
        {
            LicensePlateCollection licensePlates = ilpr.ReadFromBitmap(bitmap, customData, ref recognitionTime);
            if (licensePlates != null && licensePlates.Count > 0)
                bestLicensePlate = licensePlates[licensePlates.Count - 1];
            else
                bestLicensePlate = null;
            return licensePlates;
        }

        public void ReadFromBuffer(int pBuffer, int width, int height, int stride, int bpp, int customData)
        {
            ilpr.ReadFromBuffer(pBuffer, width, height, stride, bpp, customData);
        }

        public void ReadFromDIB(int hDIB, int customData)
        {
            ilpr.ReadFromDIB(hDIB, customData);
        }

        public LicensePlateCollection ReadFromFile(string fileName, int customData, ref int recognitionTime, ref LicensePlate bestLicensePlate)
        {
            LicensePlateCollection licensePlates = ilpr.ReadFromFile(fileName, customData, ref recognitionTime);
            if (licensePlates != null && licensePlates.Count > 0)
                bestLicensePlate = licensePlates[licensePlates.Count - 1];
            else
                bestLicensePlate = null;
            return licensePlates;
        }

        public void ReadFromMemFile(object fileData, int dataLen, int customData)
        {
            ilpr.ReadFromMemFile(fileData, dataLen, customData);
        }

        public void Reset()
        {
            ilpr.Reset();
        }

        // http://www.iso.org/iso/about/iso_members.htm
        // Viet Nam: VN
        public void SetCountryCode(string countryCode)
        {
            ilpr.SetCountryCode(countryCode);
        }

        public void SetMaskFromBitmap(int hBitmap)
        {
            ilpr.SetMaskFromBitmap(hBitmap);
        }

        public void SetMaskFromBitmap(Bitmap Bitmap)
        {
            ilpr.SetMaskFromBitmap(Bitmap);
        }

        public void SetMaskFromFile(string imageFileName)
        {
            ilpr.SetMaskFromFile(imageFileName);
        }

        public void SetScanRectangle(int left, int top, int right, int bottom)
        {
            ilpr.SetScanRectangle(left, top, right, bottom);
        }

        // Version
        public string GetVersion
        {
            get
            {
                return ilpr.GetVersion;
            }
        }

        public Rectangle[] ScanRectangle
        {
            get { return ilpr.ScanRectangle; }
            set { ilpr.ScanRectangle = value; }
        }

    }
}
