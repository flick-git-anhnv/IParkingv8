using Futech.Tools;
using System;
using System.Collections.Generic;
using System.IO.Ports;
using System.Linq;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;


namespace Futech.Objects
{
    public class C3_400
    {
        #region:Properties
        public PULLHELPER pullHelper = new PULLHELPER();
        #region:Const   
        private const int PING_TIMEOUT = 500;
        private const int COMMUNICATION_RS485 = 0;
        private const int COMMUNICATION_TCP_IP = 1;
        private const int RELAY_TIMEOUT = 1000;
        #endregion

        #region:Thread
        private Thread thread = null;
        private ManualResetEvent stopEvent = null;
        #endregion

        #region:ControllerInfor
        private int address = 0;
        private int baudrate = 9600;
        private string comport = "COM4";
        private bool isconnect = true;
        private int communicationtype = 0;
        private int delaytime = 250;
        private int lineID = 0;
        public ControllerCollection controllers = null;
        private IntPtr userHandle;
        private int connectTimeOut = 2000;
        private int deviceID;
        private string devicePassword;
        private const int BUFFERSIZE = 1 * 1024 * 1024;
        #endregion

        #region:Event
        public event CardEventHandler CardEvent;
        public event InputEventHandler InputEvent;
        #endregion

        #region:Getter,Setter
        public int LineID
        {
            set { lineID = value; }
        }
        public int DelayTime
        {
            get { return delaytime; }
            set { delaytime = value; }
        }
        public int CommunicationType
        {
            get { return communicationtype; }
            set { communicationtype = value; }
        }
        public bool IsConnect
        {
            get { return isconnect; }
            set { isconnect = value; }
        }
        public string ComPort
        {
            get { return comport; }
            set { comport = value; }
        }
        public int BaudRate
        {
            get { return baudrate; }
            set { baudrate = value; }
        }
        public int Address
        {
            get { return address; }
            set { }
        }
        public bool isInFireAlarm { get; set; }
        public IntPtr UserHandle { get => userHandle; set => userHandle = value; }
        public int ConnectTimeOut { get => connectTimeOut; set => connectTimeOut = value; }
        public int DeviceID { get => deviceID; set => deviceID = value; }
        public string DevicePassword { get => devicePassword; set => devicePassword = value; }
        #endregion
        #endregion

        #region:Constructor
        public C3_400()
        {
        }
        #endregion

        #region: Connect
        public bool Connect(string _ComPort, int _BaudRate, int _CommunicationType)
        {
            try
            {
                ComPort = _ComPort;
                BaudRate = _BaudRate;
                CommunicationType = _CommunicationType;

                if (isRS485Connection(CommunicationType))
                {
                    if (pullHelper.ConnectByRS485(comport, baudrate, DeviceID, ConnectTimeOut, DevicePassword, ref userHandle) == IntPtr.Zero)
                    {
                        IsConnect = false;
                        return false;
                    }
                    //IsConnect = true;
                    return true;
                }
                else
                {
                    if (pullHelper.ConnectByTCP(comport, baudrate, ConnectTimeOut, DevicePassword, ref userHandle) == IntPtr.Zero)
                    {
                        IsConnect = false;
                        return false;
                    }
                    //isconnect = true;
                    return true;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ket noi den thiet bi\n" + ex.Message);
            }
            IsConnect = false;
            return false;
        }
        public bool Disconnect()
        {
            if (this.userHandle == IntPtr.Zero)
            {
                return true;
            }
            else
            {
                try
                {
                    pullHelper.Disconnect(ref this.userHandle);
                    return true;
                }
                catch
                {
                    return false;
                }
            }
        }
        #endregion

        #region GetEvent
        public void PollingStart(ControllerCollection controllers)
        {
            if (thread == null)
            {
                this.controllers = controllers;

                // create events
                stopEvent = new ManualResetEvent(false);

                // start thread
                thread = new Thread(new ThreadStart(WorkerThread));
                thread.Start();
            }
        }
        public bool Running
        {
            get
            {
                if (thread != null)
                {
                    if (thread.Join(0) == false)
                        return true;

                    // the thread is not running, so free resources
                    Free();
                }
                return false;
            }
        }
        // Signal thread to stop work
        public void SignalToStop()
        {
            // stop thread
            if (thread != null)
            {
                // signal to stop
                stopEvent.Set();
            }
        }
        public void WaitForStop()
        {
            try
            {
                if (thread != null)
                {
                    // wait for thread stop
                    thread.Join();

                    Free();
                }
            }
            catch (Exception ex)
            {

                throw;
            }

        }
        private void Free()
        {
            thread = null;
            // release events
            stopEvent.Close();
            stopEvent = null;
        }
        public void PollingStop()
        {
            if (this.Running)
            {
                SignalToStop();
                while (thread.IsAlive)
                {
                    if (WaitHandle.WaitAll(
                        (new ManualResetEvent[] { stopEvent }),
                        100,
                        true))
                    {
                        WaitForStop();
                        break;
                    }

                }
            }
        }
        public void WorkerThread()
        {

            while (!stopEvent.WaitOne(0, true))
            {
                try
                {
                    foreach (Controller controller in controllers)
                    {
                        //controller.con
                        int ret = 0, buffersize = 256;
                        string str = "";
                        string[] tmp = null;
                        byte[] buffer = new byte[256];
                        if (IntPtr.Zero != this.userHandle)
                        {
                            while (!isSetDatTime)
                            {
                                SetDateTime(DateTime.Now.ToString());
                            }
                            ret = PULLSDK.GetRTLog(userHandle, ref buffer[0], buffersize);
                            if (ret >= 0)
                            {
                                controller.IsConnect = true;
                                str = Encoding.Default.GetString(buffer);
                                //time,pin,cardno,door,eventType,entry/Edit,verifyMode
                                tmp = str.Split(',');
                                string time = tmp[0];
                                string cardno = tmp[2];
                                int index = int.Parse(tmp[3]);
                                string eventType = tmp[4];
                                int entryOrExit = int.Parse(tmp[5]);

                                if (eventType != "255")
                                {
                                    const string AUX_EVENT = "221";
                                    const string INPUT_EVENT = "202";
                                    const string CARD_EVENT = "27";


                                    if (eventType == AUX_EVENT || eventType == INPUT_EVENT)
                                    {
                                        InputEventArgs e = new InputEventArgs();
                                        e.Inputport = index.ToString();
                                        e.LineID = controller.LineID;
                                        e.LineCode = controller.LineCode;
                                        e.ControllerAddress = controller.Address;
                                        e.EventTime = time;
                                        e.EventDate = DateTime.Now.ToShortDateString();
                                        if(eventType == AUX_EVENT)
                                        {
                                            e.EventType = e.Inputport == "1" ? "MSGA" : "MSGB";
                                        }
                                        else
                                        {
                                            e.EventType = e.Inputport == "1" ? "Exit" : "ExitB";
                                        }
                                        e.IsOpenDoor = false;
                                        InputEvent?.Invoke(this, e);
                                    }
                                    else if (eventType == CARD_EVENT)
                                    {
                                        CardEventArgs e = new CardEventArgs();
                                        e.LineID = controller.LineID;
                                        e.LineCode = controller.LineCode;
                                        e.ControllerAddress = controller.Address;
                                        e.Time = time;
                                        e.Date = DateTime.Now.ToShortDateString();
                                        e.CardNumber = cardno;
                                        e.EventCode = eventType;
                                        e.ReaderIndex = entryOrExit == 1 ? index + 1 : index ;
                                        CardEvent?.Invoke(this, e);
                                    }
                                }
                                else
                                {

                                }
                            }
                            else
                            {
                                controller.IsConnect = Connect(this.comport, this.baudrate, this.communicationtype);
                            }
                        }
                        else
                        {
                            controller.IsConnect = Connect(this.comport, this.baudrate, this.communicationtype);
                        }
                    }
                    Thread.Sleep(300);
                }

                catch (Exception ex)
                {
                    SystemUI.SaveLogFile("WorkerThread\n" + lineID.ToString() + "\n" + ex.Message);
                }

            }
        }
        #endregion

        #region: Device Infor
        public string GetFirmwareVersion()
        {
            int ret = 0, i = 0;
            int BUFFERSIZE = 10 * 1024 * 1024;
            byte[] buffer = new byte[BUFFERSIZE];
            string str = null;
            string tmp = null;
            string[] value = null;
            ret = pullHelper.GetDeviceParam(this.UserHandle, ref buffer[0], BUFFERSIZE, str);       //obtain device's param value
            if (ret >= 0)
            {
                tmp = Encoding.Default.GetString(buffer);
                value = tmp.Split(',');
                string[] sub_str = value[0].Split('=');
                if (sub_str.Length >= 2)
                    return sub_str[1].ToString();
            }
            return "";
        }
        #endregion

        #region: User
        #region:Get
        public List<Employee> GetAllUser(List<Employee> userList)
        {
            return pullHelper.GetAllUser(this.userHandle, userList);
        }
        #endregion
        #region: Add
        /// <summary>
        /// GetDoors
        /// </summary>
        /// <param name="doors">Doors gửi từ web xuống có dạng 1;2;3=> chuyển về dạng BCD vd 1;2;3=>2^0+2^1+2^2=7</param>
        /// <returns></returns>
        private int GetDoor(string doors)
        {
            string[] subDoors = doors.Split(';');
            int doorIndex = 0;
            for (int i = 0; i < subDoors.Length; i++)
            {
                doorIndex += (int)Math.Pow(2, Convert.ToInt32(subDoors[i]) - 1);
            }
            return 1;
        }
        public bool DownloadUser(Employee employee, string doors, int timeZoneID)
        {
            //if (this.userHandle == IntPtr.Zero)
            //{
            //    return false;
            //}
            //DeleteUser(employee);
            //string userID = employee.UserIDofFinger.ToString();
            //string startTime = employee.StartTime;
            //string endTime = employee.EndTime;
            ////only Proximity Card Ex: 0009308392
            //string cardNo = employee.CardNumber;
            //string fingerTemplate = employee.Fingers1;
            //string password = employee.Password;
            //int doorIndex = GetDoor(doors);
            //if (pullHelper.DownloadUser(this.userHandle, userID, cardNo, employee, startTime, endTime, password, doorIndex, timeZoneID))
            //{
            //    return true;
            //}
            return false;
        }
        #endregion
        #region: Delete
        public bool DeleteUser(Employee employee)
        {
            //if (this.userHandle == IntPtr.Zero)
            //{
            //    return false;
            //}
            //return pullHelper.DeleteUserByPIN(this.userHandle, employee.UserIDofFinger.ToString());
            return false;
        }
        #endregion
        #endregion

        #region: Control Device
        #region:Relay
        private enum OperationID
        {
            OutputOperation,
            CancelAlarm,
            RestartDevice,
            Enable_DisableNormalOpenState
        }
        private enum OutputOperationType
        {
            DoorNumber,
            AuxiliaryNumber
        }
        public bool OpenDoor(int relayIndex)
        {
            int operationID = (int)OperationID.OutputOperation + 1;
            int param2 = relayIndex > GetMaxDoorNumber() ? 1 : relayIndex;
            const int NORMAL_OPEN_STATE = 5;
            int result = pullHelper.ControlDevice(this.UserHandle, operationID, param2, 1 , NORMAL_OPEN_STATE, 0, "");
            if (result == 0)
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        public bool CloseDoor(int relayIndex)
        {
            int operationID = (int)OperationID.OutputOperation + 1;
            int param1 = (int)OutputOperationType.DoorNumber + 1;
            int param2 = relayIndex > GetMaxDoorNumber() ? 1 : relayIndex;
            const int DISABLE_STATE = 0;
            int result = pullHelper.ControlDevice(this.UserHandle, operationID, param1, param2, DISABLE_STATE, 0, "");
            if (result == 0)
            {
                return true;
            }
            else
            {
                //MessageBox.Show("Control Device Error: " + Zkteco_Pull.pullHelper.GetLastErrorMessage((PULLHELPER.EM_ErrorCode)result));
                return false;
            }
        }
        public bool OpenAUX(int relayIndex)
        {
            int operationID = (int)OperationID.OutputOperation + 1;
            int param1 = (int)OutputOperationType.AuxiliaryNumber + 1;
            int param2 = relayIndex > GetMaxAUXNumber() ? 1 : relayIndex;
            const int NORMAL_OPEN_STATE = 255;
            int result = pullHelper.ControlDevice(this.UserHandle, operationID, param1, param2, NORMAL_OPEN_STATE, 0, "");
            if (result == 0)
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        public bool CloseAUX(int relayIndex)
        {
            int operationID = (int)OperationID.OutputOperation + 1;
            int param1 = (int)OutputOperationType.DoorNumber + 1;
            int param2 = relayIndex > GetMaxAUXNumber() ? 1 : relayIndex;
            const int DISABLE_STATE = 0;
            int result = pullHelper.ControlDevice(this.UserHandle, operationID, param1, param2, DISABLE_STATE, 0, "");
            if (result == 0)
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        int GetMaxDoorNumber()
        {
            int ret = 0, i = 0;
            int BUFFERSIZE = 10 * 1024 * 1024;
            byte[] buffer = new byte[BUFFERSIZE];
            string str = "LockCount";
            string tmp = null;
            string[] value = null;
            ret = pullHelper.GetDeviceParam(this.UserHandle, ref buffer[0], BUFFERSIZE, str);
            tmp = Encoding.Default.GetString(buffer);
            if (ret >= 0)
            {
                tmp = Encoding.Default.GetString(buffer);
                value = tmp.Split(',');
                string[] sub_str = value[0].Split('=');
                return Convert.ToInt32(sub_str[1].ToString());
            }
            else
            {
                return 0;
            }
        }
        int GetMaxAUXNumber()
        {
            int ret = 0, i = 0;
            int BUFFERSIZE = 10 * 1024 * 1024;
            byte[] buffer = new byte[BUFFERSIZE];
            string str = "AuxInCount";
            string tmp = null;
            string[] value = null;
            ret = pullHelper.GetDeviceParam(this.UserHandle, ref buffer[0], BUFFERSIZE, str);
            tmp = Encoding.Default.GetString(buffer);
            if (ret >= 0)
            {
                tmp = Encoding.Default.GetString(buffer);
                value = tmp.Split(',');
                string[] sub_str = value[0].Split('=');
                return Convert.ToInt32(sub_str[1].ToString());
            }
            else
            {
                return 0;
            }
        }
        #endregion

        #region:Log
        public void GetTransactionLog()
        {
            throw new NotImplementedException();
        }
        public bool ClearTransactionLog()
        {
            throw new NotImplementedException();
        }
        #endregion
        #endregion

        #region: DateTime
        //Sync
        public bool SyncDateTime()
        {
            return SetDateTime(DateTime.Now.ToString());
        }
        //Get
        public string GetDateTime()
        {
            return pullHelper.GetDeviceParam(this.userHandle, PULLHELPER.EM_ControllerParam.DATETIME);
        }
        private bool isSetDatTime = false;
        //Set
        public bool SetDateTime(string dateTime)
        {
            DateTime dt = DateTime.Parse(dateTime);
            int tt = ((dt.Year - 2000) * 12 * 31 + (dt.Month - 1) * 31 + (dt.Day - 1)) * (24 * 60 * 60) + dt.Hour * 60 * 60 + dt.Minute * 60 + dt.Second;
            string data = "DateTime=" + tt;

            int ret = PULLSDK.SetDeviceParam(this.UserHandle, data);    //set the select param value to device
            if (ret >= 0)
            {
                isSetDatTime = true;
                return true;
            }
            else
                return false;
        }
        #endregion

        #region: Timezone
        public bool DownloadTimezone(int timezoneID, string[] timezoneString)
        {
            int ret = 0, tt = 0;
            string timezoneData = "TimezoneId=" + timezoneID + "\t";
            for (int i = 0; i < timezoneString.Length; i++)
            {
                if (timezoneString[i] != "")
                {
                    timezoneData = timezoneData + timezoneString[i];
                    if (i < timezoneString.Length - 1)
                    {
                        timezoneData = timezoneData + '\t';
                    }
                }

            }
            DateTime dt;
            ret = pullHelper.SetDeviceData(this.UserHandle, PULLHELPER.EM_FunctionTableNam.timezone.ToString(), timezoneData, "");
            if (ret >= 0)
                return true;
            else
                return false;
        }
        public bool GetTimeZone(ref string timeZoneString, int TimeZoneID)
        {
            int ret = 0, i = 0;
            int BUFFERSIZE = 10 * 1024 * 1024;
            byte[] buffer = new byte[BUFFERSIZE];
            string str = null;
            string response = null;
            string[] value = null;
            string filter = "TimezoneId=" + TimeZoneID;
            ret = pullHelper.GetDeviceData(this.UserHandle, ref buffer[0], BUFFERSIZE, PULLHELPER.EM_FunctionTableNam.timezone.ToString(), timeZoneString, filter, "");
            if (ret >= 0)
            {
                timeZoneString = Encoding.Default.GetString(buffer);
                return true;
            }
            else
            {
                return false;
            }
        }
        public bool DeleteTimeZone(int timezoneID)
        {
            string data = "TimezoneId=" + timezoneID;
            int ret = pullHelper.DeleteDeviceData(this.UserHandle, PULLHELPER.EM_FunctionTableNam.timezone.ToString(), data, "");
            if (ret >= 0)
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        #endregion

        #region:TCP_IP
        public bool SetIP(string newIP)
        {
            string data = "IPAddress=" + newIP;

            int ret = PULLSDK.SetDeviceParam(this.UserHandle, data);    //set the select param value to device
            if (ret >= 0)
            {
                return true;
            }
            else
                return false;
        }
        public string GetIP(ref string IPAddress)
        {
            IPAddress = pullHelper.GetDeviceParam(this.userHandle, PULLHELPER.EM_ControllerParam.IPADDRESS);
            return IPAddress;
        }
        #endregion

        #region: System
        public bool RestartDevice()
        {
            int operationID = (int)OperationID.RestartDevice + 1;
            int param1 = 0;
            int param2 = 0;
            int param3 = 0;
            int result = pullHelper.ControlDevice(this.UserHandle, operationID, param1, param2, param3, 0, "");
            if (result == 0)
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        public bool InitCardEvent()
        {
            return false;
        }
        public bool ResetDefault()
        {
            return false;
        }
        #endregion

        public string GetCardNo(ref bool isCancel)
        {
            int ret = 0, i = 0, buffersize = 256;
            string str = "";
            string[] tmp = null;
            byte[] buffer = new byte[256];
            while (!isCancel)
            {
                if (tmp == null || tmp[2].Length != 7)
                {
                    ret = PULLSDK.GetRTLog(this.userHandle, ref buffer[0], buffersize);
                    if (ret >= 0)
                    {
                        str = Encoding.Default.GetString(buffer);
                        tmp = str.Split(',');
                    }
                }
                else
                {
                    return tmp[2];
                }
                Thread.Sleep(1000);
            }
            return "";
        }
        private bool isRS485Connection(int CommunicationType)
        {
            if (communicationtype == COMMUNICATION_RS485)
            {
                return true;
            }
            return false;
        }

        public bool IsReadingEvent { get; set; } = false;
    }
}

