using System;
using System.Collections;
using System.Collections.Generic;
using System.Text;
using System.IO;
using System.IO.Ports;
using System.Threading;
using System.Windows.Forms;
using System.Net.Sockets;
using System.Net.NetworkInformation;
using Futech.Tools;

namespace Futech.Objects
{
    public class HSR900
    {
        // Serial
        public SerialPort serialPort = null;

        // TCP/IP
        private TcpClient tcpclient = null;
        private NetworkStream networkstream = null;

        // CardEvent 
        public event CardEventHandler CardEvent;

        private Thread thread = null;
        private ManualResetEvent stopEvent = null;

        // all controller in line
        private ControllerCollection controllers = null;

        // Constructor
        public HSR900()
        {
        }

        #region Property

        // Line ID
        private int lineID = 0;
        public int LineID
        {
            get { return lineID; }
            set { lineID = value; }
        }

        // Thoi gian tre lay du lieu
        private int delaytime = 1500;
        public int DelayTime
        {
            get { return delaytime; }
            set { delaytime = 300; }
        }

        // Communication Type
        private int communicationtype = 0;
        public int CommunicationType
        {
            get { return communicationtype; }
            set { communicationtype = value; }
        }

        private bool isconnect = false;
        public bool IsConnect
        {
            get { return isconnect; }
            set { isconnect = value; }
        }

        // ComPort
        private string comport = "COM14";
        public string ComPort
        {
            get { return comport; }
            set { comport = value; }
        }

        // BaudRate
        private int baudrate = 9600;
        public int BaudRate
        {
            get { return baudrate; }
            set { baudrate = value; }
        }

        // Dia chi thiet bi
        private int address = 0;
        private byte add1 = 0x30, add2 = 0x30, add3 = 0x30;
        public int Address
        {
            get { return address; }
            set 
            { 
                address = value;
                add1 = Convert.ToByte(ByteUI.Asc(address.ToString("000").Substring(0, 1)));
                add2 = Convert.ToByte(ByteUI.Asc(address.ToString("000").Substring(1, 1)));
                add3 = Convert.ToByte(ByteUI.Asc(address.ToString("000").Substring(2, 1)));
            }
        }

        // System Code
        private string systemCode = "11111111";
        private byte systemCode1 = 0x00, systemCode2 = 0x00, systemCode3 = 0x00, systemCode4 = 0x00;
        public string SystemCode
        {
            get { return systemCode; }
            set
            {
                systemCode = value;
                systemCode1 = ByteUI.StrToBase(systemCode.Substring(0, 2));
                systemCode2 = ByteUI.StrToBase(systemCode.Substring(2, 2));
                systemCode3 = ByteUI.StrToBase(systemCode.Substring(4, 2));
                systemCode4 = ByteUI.StrToBase(systemCode.Substring(6, 2));
            }
        }

        // Chuc nang
        private int fid = 0;
        public int FID
        {
            get { return fid; }
            set { fid = value; }
        }

        // Advance
        private int advance = 0;
        public int Advance
        {
            get { return advance; }
            set { advance = value; }
        }

        // PayMode
        private int paymode = 0;
        public int PayMode
        {
            get { return paymode; }
            set { paymode = value; }
        }

        // Value
        private int value1;
        private byte value11 = 0x00, value12 = 0x00, value13 = 0x00, value14 = 0x00;
        public int Value1
        {
            get { return value1; }
            set
            {
                value1 = value;
                byte[] bytes = BitConverter.GetBytes(value);
                value11 = bytes[0];
                value12 = bytes[1];
                value13 = bytes[2];
                value14 = bytes[3];
            }
        }

        // DO1 Delay Time (sec)
        private int do1delaytime = 0;
        private byte do1delaytime1 = 0x00, do1delaytime2 = 0x00;
        public int DO1DelayTime
        {
            get { return do1delaytime; }
            set
            {
                do1delaytime = value;
                byte[] bytes = BitConverter.GetBytes((ushort)value);
                do1delaytime1 = bytes[0];
                do1delaytime2 = bytes[1];
            }
        }

        // DO1 Period Time (sec)
        private int do1periodtime = 0;
        private byte do1periodtime1 = 0x00, do1periodtime2 = 0x00;
        public int DO1PeriodTime
        {
            get { return do1periodtime; }
            set
            {
                do1periodtime = value;
                byte[] bytes = BitConverter.GetBytes((ushort)value);
                do1periodtime1 = bytes[0];
                do1periodtime2 = bytes[1];
            }
        }

        // LED Status Of Success
        private int ledstatusofsuccess = 0;
        public int LEDStatusOfSuccess
        {
            get { return ledstatusofsuccess; }
            set { ledstatusofsuccess = value; }
        }

        // Ma he thong (KeyA, KeyB)
        private string keyA = "FFFFFFFFFFFF";
        private byte keyA1 = 0xFF, keyA2 = 0xFF, keyA3 = 0xFF, keyA4 = 0xFF, keyA5 = 0xFF, keyA6 = 0xFF;
        public string KeyA
        {
            set
            {
                keyA = value;
                keyA1 = ByteUI.StrToBase(keyA.Substring(0, 2));
                keyA2 = ByteUI.StrToBase(keyA.Substring(2, 2));
                keyA3 = ByteUI.StrToBase(keyA.Substring(4, 2));
                keyA4 = ByteUI.StrToBase(keyA.Substring(6, 2));
                keyA5 = ByteUI.StrToBase(keyA.Substring(8, 2));
                keyA6 = ByteUI.StrToBase(keyA.Substring(10, 2));
            }
        }

        private string keyB = "FFFFFFFFFFFF";
        private byte keyB1 = 0xFF, keyB2 = 0xFF, keyB3 = 0xFF, keyB4 = 0xFF, keyB5 = 0xFF, keyB6 = 0xFF;
        public string KeyB
        {
            set
            {
                keyB = value;
                keyB1 = ByteUI.StrToBase(keyB.Substring(0, 2));
                keyB2 = ByteUI.StrToBase(keyB.Substring(2, 2));
                keyB3 = ByteUI.StrToBase(keyB.Substring(4, 2));
                keyB4 = ByteUI.StrToBase(keyB.Substring(6, 2));
                keyB5 = ByteUI.StrToBase(keyB.Substring(8, 2));
                keyB6 = ByteUI.StrToBase(keyB.Substring(10, 2));
            }
        }

        private string[] mess = new string[20];
        public string[] Mess
        {
            get { return mess; }
            set { mess = value; }
        }

        #endregion

        // Ket noi den thiet bi
        public bool Connect(string _ComPort, int _BaudRate, int _CommunicationType)
        {
            try
            {
                ComPort = _ComPort;
                BaudRate = _BaudRate;
                CommunicationType = _CommunicationType;

                if (CommunicationType == 0)
                {
                    serialPort = new SerialPort();
                    serialPort.PortName = ComPort;
                    serialPort.BaudRate = BaudRate;
                    serialPort.ReadBufferSize = 4096;
                    serialPort.WriteBufferSize = 4096;
                    serialPort.DataBits = 8;
                    serialPort.ReadTimeout = -1;
                    serialPort.WriteTimeout = -1;
                    serialPort.DtrEnable = true;
                    serialPort.RtsEnable = true;
                    serialPort.InitializeLifetimeService();
                   
                    serialPort.Open();
                    IsConnect = true;

                    return true;
                }
                else
                {

                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ket noi den thiet bi\n" + ex.Message);
                SystemUI.SaveLogFile("Connect: " + ex.Message);
            }
            IsConnect = false;
            return false;
        }

        //byte[] buff = new byte[20];
        //int index = 0;
        //void serialPort_ErrorReceived(object sender, SerialErrorReceivedEventArgs e)
        //{
        //    SystemUI.SaveLogFile(e.EventType.ToString());
        //}

        //void serialPort_DataReceived(object sender, SerialDataReceivedEventArgs e)
        //{
        //    try
        //    {              
        //        string viewraw = "";
                
        //        while (serialPort.BytesToRead > 0 && index < 20)
        //        {
        //            buff[index] = (Byte)serialPort.ReadByte();
        //            if (viewraw == "")
        //                viewraw = ByteUI.DecimalToBase(buff[index], 16);
        //            else
        //                viewraw = viewraw + " " + ByteUI.DecimalToBase(buff[index], 16);
        //            index++;
        //        }
        //        if (index == 20)
        //        {
        //            string str = "";
        //            if (viewraw != "" && viewraw.Contains(" "))
        //            {
                       
        //                string[] _mess = viewraw.Split(' ');
                       
        //                for (int i = 0; i < 20; i++)
        //                {
        //                    mess[i] = _mess[i];
        //                    if (i > 1 && i < 18)
        //                        str += mess[i];
        //               }                      
        //            }

        //            //if (mess[1] == "4E" && str != "30303030303030303030303030303030")
        //            {

        //                foreach (Futech.Objects.Controller controller in controllers)
        //                {
        //                    CardEventArgs ex = new CardEventArgs();
        //                    string MESSID = System.Text.Encoding.UTF8.GetString(buff).Substring(2, 16);

        //                    ex.LineID = controller.LineID;
        //                    ex.ControllerAddress = controller.Address;
        //                    ex.CardNumber = MESSID;
        //                    ex.Date = DateTime.Now.ToString("yyyy/MM/dd");
        //                    ex.Time = DateTime.Now.ToString("HH:mm:ss");
        //                    ex.ReaderIndex = 1;
        //                    ex.EventStatus = "Access Granted";
        //                    CardEvent(this, ex);

        //                    break;
        //                }
        //            }
        //            index = 0;
                   
        //        }

        //    }
        //    catch (Exception exp)
        //    {
        //        SystemUI.SaveLogFile("Error while writing to logfile: " + exp.Message);
        //        MessageBox.Show(exp.Message);
        //    }
        //}

        // Ngung ket noi den thiet bi
        public bool Disconnect()
        {
            try
            {
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                        serialPort.Close();
                    return true;
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ngung ket noi den thiet bi\n" + ex.Message);
            }
            return false;
        }

        // Thuc hien lenh den thiet bi (pc <-> host)
        // Response Function 06 - ACK Acknowledge, 15 - NAK Negative Acknowledge, 12 - EVN Event Message    
        private string ExecuteCommand(byte[] buffer, string command, ref string viewraw, ref string[] message)
        {
            try
            {
                viewraw = "";
                message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // pc to host
                        if (buffer != null)
                            serialPort.Write(buffer, 0, buffer.Length);

                        Thread.Sleep(delaytime);

                        // host to pc
                        buffer = new byte[20];
                        viewraw = "";
                        message = null;
                        int index = 0;
                        if (serialPort.BytesToRead > 0 && serialPort.BytesToRead < 20)//posible ocuss
                        {
                            Application.DoEvents();
                            Thread.Sleep(50);
                        }
                        while (serialPort.BytesToRead > 0 && index < 20)
                        {
                            buffer[index] = (Byte)serialPort.ReadByte();
                            if (viewraw == "")
                                viewraw = ByteUI.DecimalToBase(buffer[index], 16);
                            else
                                viewraw = viewraw + " " + ByteUI.DecimalToBase(buffer[index], 16);
                            index = index + 1;
                        }
                        if (viewraw != "" && viewraw.Contains(" "))
                        {
                            message = viewraw.Split(' ');

                            return System.Text.Encoding.UTF8.GetString(buffer);
                        }
                    }
                    else
                        Thread.Sleep(delaytime);
                }
                else
                {

                }
            }
            catch (Exception ex)
            {
                //MessageBox.Show("Thuc hien lenh den thiet bi (pc <-> host)\n" + ex.Message);
                SystemUI.SaveLogFile("Thuc hien lenh den thiet bi (pc <-> host)\n" + ex.Message);
            }
            return "";
        }

        #region GetEvent

        // Start
        public void PollingStart(ControllerCollection controllers)
        {
            if (thread == null)
            {
                this.controllers = controllers;

                // create events
                stopEvent = new ManualResetEvent(false);

                // start thread
                thread = new Thread(new ThreadStart(WorkerThread));
                thread.Start();
            }
            
        }

        // is Running
        public bool Running
        {
            get
            {
                if (thread != null)
                {
                    if (thread.Join(0) == false)
                        return true;

                    // the thread is not running, so free resources
                    Free();
                }
                return false;
            }
        }

        // Signal thread to stop work
        public void SignalToStop()
        {
            // stop thread
            if (thread != null)
            {
                // signal to stop
                stopEvent.Set();
            }
        }

        // Wait for thread stop
        public void WaitForStop()
        {
            if (thread != null)
            {
                // wait for thread stop
                thread.Join();

                Free();
            }
        }

        // Free resources
        private void Free()
        {
            thread = null;

            // release events
            stopEvent.Close();
            stopEvent = null;
        }

        // Stop
        public void PollingStop()
        {
            if (this.Running)
            {
                SignalToStop();
                while (thread.IsAlive)
                {
                    if (WaitHandle.WaitAll(
                        (new ManualResetEvent[] { stopEvent }),
                        100,
                        true))
                    {
                        WaitForStop();
                        break;
                    }

                    Application.DoEvents();
                }
            }
        }

        // Worker thread
        public void WorkerThread()
        {
            while (!stopEvent.WaitOne(0, true))
            {
                try
                {
                    string viewraw = "";
                    string[] message = null;

                    if (CommunicationType == 0)
                    {
                        if (serialPort.IsOpen)
                        {
                            foreach (Futech.Objects.Controller controller in controllers)
                            {
                                Address = controller.Address;

                                byte[] bytes = null;
                                string MESSID = ExecuteCommand(bytes, "", ref viewraw, ref message);
                                // Thuc hien lenh den thiet bi (pc <-> host)
                                if (MESSID != "" && message.Length == 20 && message[0] == "02" && message[19] == "03")
                                {
                                    controller.IsConnect = true; // Thiet bi online
                                    string str = "";
                                    for (int i = 2; i < 18; i++)
                                        str += message[i];

                                    //Chi lay du lieu nhung the khong hop le
                                    if (message[1] == "4E" && str != "30303030303030303030303030303030" && CardEvent != null)
                                    {
                                        CardEventArgs ex = new CardEventArgs();
                                        ex.LineID = controller.LineID;
                                        ex.ControllerAddress = controller.Address;
                                        ex.CardNumber = MESSID.Substring(2, 16);
                                        ex.Date = DateTime.Now.ToString("yyyy/MM/dd");
                                        ex.Time = DateTime.Now.ToString("HH:mm:ss");
                                        ex.ReaderIndex = 1;
                                        ex.EventStatus = "Access Granted";
                                        CardEvent(this, ex);
                                    }
                                   
                                }
                                else
                                    controller.IsConnect = false; // Thiet bi offline
                            }
                        
                        }
                        else
                        {
                            Application.DoEvents();
                            Thread.Sleep(500);
                        }
                    
                    }
                    else
                    {
                    }
                
                    GC.Collect();
                }
                catch (Exception ex)
                {
                    //MessageBox.Show(ex.Message);
                    SystemUI.SaveLogFile("WorkerThread\n" + lineID.ToString() + "\n" + ex.Message);
                }
            }
        }

        #endregion

        #region Method

        // Get Version
        public string GetVersion()
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Polling
                        // 01 01 00 00 00 20
                        byte[] bytes = null;
                        bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x00, 0x00, 0xC0, 0x71 };
                        CRC16 crc16 = new CRC16();
                        string crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                        bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                        bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                        {
                            // Get Version
                            // 01 01 01 00 90 21 
                            bytes = null;
                            bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x01, 0x00, 0x90, 0x21 };
                            crc16 = new CRC16();
                            crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                            bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                            bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                            string controllerinfo = ExecuteCommand(bytes, "", ref viewraw, ref message);

                            if (controllerinfo != "")
                            {
                                // Kiem tra tong so su kien
                                // 01 01 0B 00 30 27
                                bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x0B, 0x00, 0x30, 0x27 };
                                crc16 = new CRC16();
                                crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                                bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                                bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                                // Thuc hien lenh den thiet bi (pc <-> host)
                                int RecordCount = 0;
                                if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                                {
                                    RecordCount = ByteUI.BaseToDecimal(message[4] + message[5], 16);
                                }

                                controllerinfo = RecordCount + " \\ " + controllerinfo;

                                return controllerinfo;
                            }
                        }
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // Get Date/Time
       public void GetTimePeriod(ref string time,ref int baudrate)
       {
           try
           {
               string viewraw = "";
               string[] message = null;
               byte[] temp = new byte[] { 0x02, 0x47, 0x30, //SXT,'P','C'
                   0x30,                                    //Baudrate='3' (19200)       
                   0x30, 0x30, 0x30,                        //'S','U','2'
                   0x30, 0x30,                              //P1P0='10'
                   0x30, 0x30,                              //R1R0='01' thoi gian tre relay
                   0x30, 0x30,                              //T1T0='30' khoang thoi gian giua hai lan nhan the
                   0x30,                                    //Id='8'
                   0x30,                                    //S='1' su dung sensor B, chap 2 chan COM va S1 thi moi nhan the
                   0x30, 0x30, 0x30,                        //Future
                   0x30,                                    //XOR cac byte phia truoc
                   0x03 };                                  //ETX=0x03

               temp[18] = XOR(temp, 0, 18);
               if (ExecuteCommand(temp, "", ref viewraw, ref message) != "" && message.Length == 20 && message[1] == "50")
               {
                   baudrate = Convert.ToInt32(ByteUI.AscToStr(message[3]));
                   time = ByteUI.AscToStr(message[11]) + ByteUI.AscToStr(message[12]);
               }
               else
               {
                   MessageBox.Show("Error while reading from controller - 1");
               }
             
           }
           catch
           {
               MessageBox.Show("Error while reading from controller - 2");
           }

       }

        //Set time period
        public void SetTimePeriod(string time, int baudrate)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                byte[] temp = new byte[] { 0x02, 0x50, 0x43, //SXT,'P','C'
                   0x33,                                    //Baudrate='3' (19200)       
                   0x53, 0x55, 0x32,                        //'S','U','2'
                   0x31, 0x30,                              //P1P0='10'
                   0x30, 0x31,                              //R1R0='01' thoi gian tre relay
                   0x33, 0x30,                              //T1T0='30' khoang thoi gian giua hai lan nhan the
                   0x38,                                    //Id='8'
                   0x31,                                    //S='1' su dung sensor B, chap 2 chan COM va S1 thi moi nhan the
                   0x30, 0x30, 0x30,                        //Future
                   0x2C,                                    //XOR cac byte phia truoc
                   0x03 };                                  //ETX=0x03

                temp[3] = Convert.ToByte(ByteUI.Asc(baudrate.ToString()));
                time = Convert.ToInt32(time).ToString("00");
                temp[11] = Convert.ToByte(ByteUI.Asc(time[0]));
                temp[12] = Convert.ToByte(ByteUI.Asc(time[1]));
                temp[18] = XOR(temp, 0, 18);
              
                if (ExecuteCommand(temp, "", ref viewraw, ref message) != "" && message.Length == 20)// && temp[11].ToString()==message[11] && temp[12].ToString() == message[12] && temp[3].ToString() == message[3])
                {
                    MessageBox.Show("Set timeperiod and baudrate successful");
                }
                else
                {
                    MessageBox.Show("Error while writing to controller - 1");
                }

            }
            catch
            {
                MessageBox.Show("Error while writing to controller - 2");
            }
        }

        // Get Date/Time
        public string DateTimeUpload()
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Get Date/Time
                        // 01 01 08 00 C0 27
                        byte[] bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x08, 0x00, 0xC0, 0x27 };
                        CRC16 crc16 = new CRC16();
                        string crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                        bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                        bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                        {
                            // 01 01 06 07 24 01 12 04 21 09 11 32 01
                            return "20" + message[10] + "/" + message[9] + "/" + message[8] + " " + message[6] + ":" + message[5] + ":" + message[4];
                        }
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // Set KeyA
        public bool SetKeyA(string _keyA)
        {
            try
            {
                KeyA = _keyA;
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Set KeyA
                        // 01 01 2B 08 60 00 FF FF FF FF FF FF F0 12
                        byte[] bytes = null;
                        for (int i = 0; i < 16; i++)
                        {
                            bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x2B, 0x08, 0x60, 
                                Convert.ToByte(ByteUntils.DecimalToBase(i, 16), 16),
                                keyA1, keyA2, keyA3, keyA4, keyA5, keyA6, 
                                0xF0, 0x12 };
                            CRC16 crc16 = new CRC16();
                            string crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                            bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                            bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                            // Thuc hien lenh den thiet bi (pc <-> host)
                            if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                                continue;
                            else
                                return false;
                        }
                        return true;
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Recover Record
        // Request: 09/21/2011 17:46:06.89264 (+15.8989 seconds)
        // 01 01 10 00 C0 2D                                 ....À-          
        // Answer: 09/21/2011 17:46:06.91364 (+0.0210 seconds)
        // 01 01 06 01 00 49 E0                              .....Ià         
        public bool RecoverRecord()
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Recover Record
                        // 01 01 10 00 C0 2D 
                        byte[] bytes = null;
                        bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x10, 0x00, 0xC0, 0x2D };
                        CRC16 crc16 = new CRC16();
                        string crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                        bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                        bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                            return true;
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Get Register
        // Request: 09/23/2011 10:50:19.94364 (+6726.8438 seconds)
        // 01 01 09 03 00 10 19 85 11                        .......
        // Answer: 09/23/2011 10:50:19.96064 (+0.0170 seconds)
        // 01 01 06 19 00 00 00 00 78 01 00 10 27 00 00 00   ........x...'...
        // 00 00 00 00 00 01 00 00 00 00 00 00 FF C7 ED      ............ÿÇí 
        public string[] GetRegister()
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Polling
                        // 01 01 00 00 00 20 / 01 01 06 01 00 49 E0

                        // Get Register
                        // 01 01 09 03 00 10 19 85 11 
                        byte[] bytes = null;
                        bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x09, 0x03, 0x00, 0x10, 0x19, 0x85, 0x11 };
                        CRC16 crc16 = new CRC16();
                        string crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                        bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                        bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                        {
                            Address = ByteUI.BaseToDecimal(message[1], 16);
                            SystemCode = message[7] + message[6] + message[5] + message[4];
                            FID = ByteUI.BaseToDecimal(message[8], 16);
                            bytes = ByteUI.Bytes(Convert.ToByte(ByteUI.BaseToDecimal(message[9], 16)));
                            Advance = bytes[0];
                            PayMode = bytes[1];
                            Value1 = ByteUI.BaseToDecimal(message[14] + message[13] + message[12] + message[11], 16);
                            DO1DelayTime = ByteUI.BaseToDecimal(message[16] + message[15], 16);
                            DO1PeriodTime = ByteUI.BaseToDecimal(message[18] + message[17], 16);
                            LEDStatusOfSuccess = ByteUI.BaseToDecimal(message[21], 16);

                            return message;
                        }
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return null;
        }

        // Set Register
        // Request: 09/23/2011 10:50:19.94364 (+6726.8438 seconds)
        // 01 01 09 03 00 10 19 85 11                        .......
        // Answer: 09/23/2011 10:50:19.96064 (+0.0170 seconds)
        // 01 01 06 19 00 00 00 00 78 01 00 10 27 00 00 00   ........x...'...
        // 00 00 00 00 00 01 00 00 00 00 00 00 FF C7 ED      ............ÿÇí 
        public bool SetRegister(int newaddress)
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Set Slave Addr
                        // 01 01 02 01 01(new address) 48 60      
                        byte[] bytes = null;
                        bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x02, 0x01, Convert.ToByte(ByteUntils.DecimalToBase(newaddress, 16), 16), 0x48, 0x60 };
                        CRC16 crc16 = new CRC16();
                        string crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                        bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                        bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];
                        //byte tempByte = 2^
                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                        {
                            // Set Register
                            // 01 01 0A 1B 00 10 FF FF FF FF 78 02 00 10 27 00   
                            // 00 2C 01 2C 01 00 00 01 00 00 00 00 00 00 FF E4   
                            // F7 
                            //Value1 = ByteUntils.DecimalToBase(_Value, 16);
                            bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x0A, 0x1B, 0x00, 0x10,
                                systemCode4, systemCode3, systemCode2, systemCode1,
                                Convert.ToByte(ByteUntils.DecimalToBase(fid, 16), 16),
                                ByteUI.BinToByte(paymode + "" + advance), 0x00, 
                                value11, value12, value13, value14, 
                                do1delaytime1, do1delaytime2, do1periodtime1, do1periodtime2, 0x00, 0x00,  
                                Convert.ToByte(ByteUntils.DecimalToBase(ledstatusofsuccess, 16)), 
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xE4, 0xF7 };
                            crc16 = new CRC16();
                            crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                            bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                            bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                            // Thuc hien lenh den thiet bi (pc <-> host)
                            if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                            {
                                // Reset
                                // 01 01 1E 00 A0 29   
                                bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x1E, 0x00, 0xA0, 0x29 };
                                crc16 = new CRC16();
                                crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                                bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                                bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                                // Thuc hien lenh den thiet bi (pc <-> host)
                                if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                                {
                                    return true;
                                }
                            }
                        }
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Write BlackList
        public bool WriteBlackList(BlackListCollection blacklists)
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        byte[] bytes = null;
                        CRC16 crc16 = null;
                        string crc = "";
                        // Xoa balack list
                        // 01 01 0A 04 7C 00 00 00 3A E3 
                        if (blacklists == null || blacklists.Count == 0)
                        {
                            bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x0A, 0x04, 0x7C, 0x00, 0x00, 0x00, 0x3A, 0xE3 };
                            crc16 = new CRC16();
                            crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                            bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                            bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                            // Thuc hien lenh den thiet bi (pc <-> host)
                            if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                                return true;
                        }
                        else
                        {
                            // ghi the len black list
                            // 01 01 0A 12 7C 10 AB B6 C0 58 15 09 D1 78 C7 36
                            // D1 78 A4 4F D1 78 DC BF         
                            bytes = new byte[6 + blacklists.Count * 4 + 2];
                            int i = 6;
                            foreach (BlackList blacklist in blacklists)
                            {
                                byte[] cardnumber = BitConverter.GetBytes(ByteUI.BaseToDecimal(blacklist.CardNumber,16));
                                bytes[i] = cardnumber[0];
                                bytes[i + 1] = cardnumber[1];
                                bytes[i + 2] = cardnumber[2];
                                bytes[i + 3] = cardnumber[3];
                                i = i + 4;
                            }
                            bytes[0] = 0x01;
                            bytes[1] = Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16);
                            bytes[2] = 0x0A;
                            bytes[3] = Convert.ToByte(ByteUntils.DecimalToBase(blacklists.Count*4 + 2, 16), 16);
                            bytes[4] = 0x7C;
                            bytes[5] = 0x10;

                            crc16 = new CRC16();
                            crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                            bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                            bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                            // Thuc hien lenh den thiet bi (pc <-> host)
                            if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                            {
                                // Xac nhan lai
                                // 01 01 0A 04 7C 00 03 00 CA E3
                                bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x0A, 0x04, 0x7C, 0x00, 
                                    Convert.ToByte(ByteUntils.DecimalToBase(blacklists.Count, 16), 16), 0x00, 0xCA, 0xE3 };
                                crc16 = new CRC16();
                                crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                                bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                                bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                                // Thuc hien lenh den thiet bi (pc <-> host)
                                if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                                    return true;
                            }

                        }
                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Read BlackList
        public bool ReadBlackList(ref BlackListCollection blacklists)
        {
            try
            {
                string viewraw = "";
                string[] message = null;

                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // Kiem tra tong so the trong black list
                        // 01 01 09 03 7C 00 02 96 9D
                        byte[] bytes = null;
                        CRC16 crc16 = null;
                        string crc = "";

                        bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x09, 0x03, 0x7C, 0x00, 0x02, 0x96, 0x9D };
                        crc16 = new CRC16();
                        crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                        bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                        bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                        {
                            int blacklistcount = ByteUI.BaseToDecimal(message[5] + message[4], 16);
                            if (blacklistcount > 0)
                            {
                                // Read Black List
                                // 01 01 09 03 7C 10 08 51 10 
                                // 01 01 09 03 7C 10 10 5B 10  
                                byte tempbyte = 0x08;
                                if (blacklistcount > 2)
                                    tempbyte = 0x10;
                                bytes = new byte[] { 0x01, Convert.ToByte(ByteUntils.DecimalToBase(address, 16), 16), 0x09, 0x03, 0x7C, 0x10, tempbyte, 0x51, 0x10 };
                                crc16 = new CRC16();
                                crc = crc16.ComputeChecksum(bytes, 1, bytes.Length - 2).ToString();
                                bytes[bytes.Length - 2] = ByteUI.Bytes(crc)[0];
                                bytes[bytes.Length - 1] = ByteUI.Bytes(crc)[1];

                                // Thuc hien lenh den thiet bi (pc <-> host)
                                if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[2] == "06")
                                {
                                    for (int i = 4; i <= blacklistcount*4;)
                                    {
                                        BlackList blacklist = new BlackList();
                                        //blacklist.CardNumber = ByteUI.BaseToDecimal(message[i + 3] + message[i + 2] + message[i + 1] + message[i], 16).ToString() ;
                                        blacklist.CardNumber = message[i + 3] + message[i + 2] + message[i + 1] + message[i];

                                        blacklists.Add(blacklist);
                                        i = i + 4;
                                    }
                                }
                            }
                        }


                    }
                }
                else
                {
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Unlock
        public bool Unlock(int relay, int delay)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                byte[] bytes = new byte[] { 0x02, 0x4F, 0x30, //SXT,'P','C'
                   0x30,                                    //Baudrate='3' (19200)       
                   0x30, 0x30, 0x30,                        //'S','U','2'
                   0x30, 0x30,                              //P1P0='10'
                   0x30, 0x30,                              //R1R0='01' thoi gian tre relay
                   0x30, 0x30,                              //T1T0='30' khoang thoi gian giua hai lan nhan the
                   0x30,                                    //Id='8'
                   0x72,                                    //S='1' su dung sensor B, chap 2 chan COM va S1 thi moi nhan the
                   0x31, 0x72, 0x30,                        //Future
                   0x30,                                    //XOR cac byte phia truoc
                   0x03 };                                  //ETX=0x03

                bytes[18] = XOR(bytes, 0, 18);
                ExecuteCommand(bytes, "", ref viewraw, ref message);
               
                Thread.Sleep(300);
                return true;
            }
            catch
            {
                return false;
            }
        }

        //XOR 
        private byte XOR(byte[] bytes, int index, int length)
        {
            try
            {
                byte temp = bytes[index];
                int b = Convert.ToUInt16(temp);
                for (int i = index + 1; i < length + index; i++)
                {
                    b = b ^ Convert.ToUInt16(bytes[i]);
                }

                temp = Convert.ToByte(b);
                return temp;
            }
            catch
            {
                return 0xFF;
            }
        }

        public void DeleteCard()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                byte[] temp = new byte[] { 0x02, 0x44, 0x41, //SXT,'P','C'
                   0x4C,                                    //Baudrate='3' (19200)       
                   0x4C, 0x30, 0x30,                        //'S','U','2'
                   0x30, 0x30,                              //P1P0='10'
                   0x30, 0x30,                              //R1R0='01' thoi gian tre relay
                   0x30, 0x30,                              //T1T0='30' khoang thoi gian giua hai lan nhan the
                   0x30,                                    //Id='8'
                   0x30,                                    //S='1' su dung sensor B, chap 2 chan COM va S1 thi moi nhan the
                   0x30, 0x30, 0x30,                        //Future
                   0x30,                                    //XOR cac byte phia truoc
                   0x03 };                                  //ETX=0x03

                temp[18] = XOR(temp, 0, 18);

                if (ExecuteCommand(temp, "", ref viewraw, ref message) != "" && message.Length == 20 && message[1] == "41")
                {
                    MessageBox.Show("Deleted all card in controller");
                }
                else
                {
                    MessageBox.Show("Couldn't delete card in controller - 1");
                }
              
            }
            catch
            {
                MessageBox.Show("Couldn't delete card in controller - 2");
            }
        }

        #endregion
    }
}
