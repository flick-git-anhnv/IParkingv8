using System;
using System.Collections;
using System.Collections.Generic;
using System.Text;
using System.IO;
using System.IO.Ports;
using System.Threading;
using System.Windows.Forms;
using System.Net;
using System.Net.Sockets;
using System.Net.NetworkInformation;
using Futech.Tools;
using System.Text.RegularExpressions;

namespace Futech.Objects.KZE02NETControllerv2
{
    public class KZE02NETv2
    {// Serial
        public SerialPort serialPort = null;

        // TCP/IP
        private TcpClient tcpclient = null;
        private NetworkStream networkstream = null;

        // CardEvent 
        public event CardEventHandler CardEvent;
        // InputEvent 
        public event InputEventHandler InputEvent;

        private Thread thread = null;
        private ManualResetEvent stopEvent = null;

        // all controller in line
        public ControllerCollection controllers = null;

        System.Net.Sockets.Socket UdpServer;

        UdpClient udp;
        IPEndPoint ipEpBroadcast;

        // Constructor
        public KZE02NETv2()
        {
        }

        #region Property

        // Line ID
        private int lineID = 0;
        public int LineID
        {
            set { lineID = value; }
        }

        // Thoi gian tre lay du lieu
        private int delaytime = 250;
        public int DelayTime
        {
            get { return delaytime; }
            set { delaytime = value; }
        }

        // Communication Type
        private int communicationtype = 0;
        public int CommunicationType
        {
            get { return communicationtype; }
            set { communicationtype = value; }
        }

        private bool isconnect = false;
        public bool IsConnect
        {
            get { return isconnect; }
            set { isconnect = value; }
        }

        // ComPort
        private string comport = "COM4";
        public string ComPort
        {
            get { return comport; }
            set { comport = value; }
        }

        // BaudRate
        private int baudrate = 9600;
        public int BaudRate
        {
            get { return baudrate; }
            set { baudrate = value; }
        }

        // Dia chi thiet bi
        private int address = 0;
        private byte add1 = 0x30, add2 = 0x30, add3 = 0x30;
        public int Address
        {
            get { return address; }
            set
            {
                address = value;
                add1 = Convert.ToByte(ByteUI.Asc(address.ToString("000").Substring(0, 1)));
                add2 = Convert.ToByte(ByteUI.Asc(address.ToString("000").Substring(1, 1)));
                add3 = Convert.ToByte(ByteUI.Asc(address.ToString("000").Substring(2, 1)));
            }
        }

        // System Code
        private string systemCode = "11111111";
        private byte systemCode1 = 0x00, systemCode2 = 0x00, systemCode3 = 0x00, systemCode4 = 0x00;
        public string SystemCode
        {
            set
            {
                systemCode = value;
                systemCode1 = ByteUI.StrToBase(systemCode.Substring(0, 2));
                systemCode2 = ByteUI.StrToBase(systemCode.Substring(2, 2));
                systemCode3 = ByteUI.StrToBase(systemCode.Substring(4, 2));
                systemCode4 = ByteUI.StrToBase(systemCode.Substring(6, 2));
            }
        }

        // Ma he thong
        private string keyA = "FFFFFFFFFFFF";
        private byte keyA1 = 0xFF, keyA2 = 0xFF, keyA3 = 0xFF, keyA4 = 0xFF, keyA5 = 0xFF, keyA6 = 0xFF;
        public string KeyA
        {
            set
            {
                keyA = value;
                keyA1 = ByteUI.StrToBase(keyA.Substring(0, 2));
                keyA2 = ByteUI.StrToBase(keyA.Substring(2, 2));
                keyA3 = ByteUI.StrToBase(keyA.Substring(4, 2));
                keyA4 = ByteUI.StrToBase(keyA.Substring(6, 2));
                keyA5 = ByteUI.StrToBase(keyA.Substring(8, 2));
                keyA6 = ByteUI.StrToBase(keyA.Substring(10, 2));
            }
        }

        private string keyB = "FFFFFFFFFFFF";
        private byte keyB1 = 0xFF, keyB2 = 0xFF, keyB3 = 0xFF, keyB4 = 0xFF, keyB5 = 0xFF, keyB6 = 0xFF;
        public string KeyB
        {
            set
            {
                keyB = value;
                keyB1 = ByteUI.StrToBase(keyB.Substring(0, 2));
                keyB2 = ByteUI.StrToBase(keyB.Substring(2, 2));
                keyB3 = ByteUI.StrToBase(keyB.Substring(4, 2));
                keyB4 = ByteUI.StrToBase(keyB.Substring(6, 2));
                keyB5 = ByteUI.StrToBase(keyB.Substring(8, 2));
                keyB6 = ByteUI.StrToBase(keyB.Substring(10, 2));
            }
        }

        #endregion

        // Ket noi den thiet bi
        public bool Connect(string _ComPort, int _BaudRate, int _CommunicationType)
        {
            try
            {
                ComPort = _ComPort;
                BaudRate = _BaudRate;
                CommunicationType = _CommunicationType;

                if (CommunicationType == 0)
                {
                    serialPort = new SerialPort();
                    serialPort.PortName = ComPort;
                    serialPort.BaudRate = BaudRate;
                    serialPort.ReadBufferSize = 4096;
                    serialPort.WriteBufferSize = 4096;
                    serialPort.DataBits = 8;
                    serialPort.ReadTimeout = -1;
                    serialPort.WriteTimeout = -1;
                    serialPort.DtrEnable = true;
                    serialPort.RtsEnable = true;
                    serialPort.InitializeLifetimeService();
                    serialPort.Open();
                    IsConnect = true;
                    return true;
                }
                else
                {
                    //while (true)
                    //{
                    Ping pingSender = new Ping();
                    PingReply reply = null;
                    reply = pingSender.Send(ComPort, 500);
                    if (reply != null && reply.Status == IPStatus.Success)
                        return true;
                    else
                        return false;
                    //}
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ket noi den thiet bi\n" + ex.Message);
            }
            IsConnect = false;
            return false;
        }

        // Ngung ket noi den thiet bi
        public bool Disconnect()
        {
            try
            {
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                        serialPort.Close();
                    return true;
                }
                else
                {
                    if (tcpclient != null && tcpclient.Connected)
                    {
                        tcpclient.Close();
                        tcpclient = null;
                    }
                    return true;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ngung ket noi den thiet bi\n" + ex.Message);
                return false;
            }
        }

        // Thuc hien lenh den thiet bi (pc <-> host)
        private string ExecuteCommand(byte[] buffer, string command, ref string viewraw, ref string[] message)
        {
            try
            {
                viewraw = "";
                message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // pc to host
                        serialPort.Write(buffer, 0, buffer.Length);

                        Thread.Sleep(delaytime);

                        // host to pc
                        buffer = new byte[serialPort.BytesToRead];
                        viewraw = "";
                        message = null;
                        int index = 0;
                        while (serialPort.BytesToRead > 0)
                        {
                            buffer[index] = (Byte)serialPort.ReadByte();
                            if (viewraw == "")
                                viewraw = ByteUI.DecimalToBase(buffer[index], 16);
                            else
                                viewraw = viewraw + " " + ByteUI.DecimalToBase(buffer[index], 16);
                            index = index + 1;
                        }

                        if (viewraw != "" && viewraw.Contains(" ") && ByteUI.CRC(buffer, buffer.Length, 1) == buffer[buffer.Length - 1])
                        {
                            message = viewraw.Split(' ');
                            return System.Text.Encoding.UTF8.GetString(buffer);
                        }
                    }
                    else
                        Thread.Sleep(delaytime);
                }
                else
                {
                    Ping pingSender = new Ping();
                    PingReply reply = null;
                    reply = pingSender.Send(ComPort, 500);
                    if (reply != null && reply.Status == IPStatus.Success)
                    {

                        UdpServer = new System.Net.Sockets.Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);

                        ipEpBroadcast = new IPEndPoint(IPAddress.Parse(comport), baudrate);

                        UdpServer.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.Broadcast, 1);

                        //command = "SetRelay?/Relay=01/State=OFF";
                        byte[] bData = System.Text.Encoding.ASCII.GetBytes(command);

                        UdpServer.SendTo(bData, ipEpBroadcast);

                        UdpServer.ReceiveTimeout = 2000;
                        Thread.Sleep(150);
                        viewraw = "";
                        message = null;
                        try
                        {
                            if (UdpServer.ReceiveBufferSize != 0)
                            {
                                byte[] bRebuff = new byte[UdpServer.ReceiveBufferSize];
                                int readLen = UdpServer.Receive(bRebuff);

                                byte checksum = 1;
                                for (int i = 1; i < readLen - 2; i++)
                                    checksum += bRebuff[i];

                                message = ByteUI.Message(bRebuff, readLen, ref viewraw);
                                if (message[0] == "02")// && checksum == bRebuff[readLen - 2])
                                {
                                    ByteUI.Message(bData, bData.Length, ref viewraw);
                                    return System.Text.Encoding.UTF8.GetString(bRebuff, 1, readLen - 2);
                                }

                            }
                        }
                        catch
                        {
                        }

                    }
                    else
                        Thread.Sleep(delaytime);
                }
            }
            catch (Exception ex)
            {
                //MessageBox.Show("Thuc hien lenh den thiet bi (pc <-> host)\n" + ex.Message);
                SystemUI.SaveLogFile("Thuc hien lenh den thiet bi (pc <-> host)\n" + ex.Message);
            }
            return "";
        }


        #region GetEvent

        // Start
        public void PollingStart(ControllerCollection controllers)
        {
            if (thread == null)
            {
                this.controllers = controllers;

                // create events
                stopEvent = new ManualResetEvent(false);

                // start thread
                thread = new Thread(new ThreadStart(WorkerThread));
                thread.Start();
            }
        }

        // is Running
        public bool Running
        {
            get
            {
                if (thread != null)
                {
                    if (thread.Join(0) == false)
                        return true;

                    // the thread is not running, so free resources
                    Free();
                }
                return false;
            }
        }

        // Signal thread to stop work
        public void SignalToStop()
        {
            // stop thread
            if (thread != null)
            {
                // signal to stop
                stopEvent.Set();
            }
        }

        // Wait for thread stop
        public void WaitForStop()
        {
            if (thread != null)
            {
                // wait for thread stop
                thread.Join();

                Free();
            }
        }

        // Free resources
        private void Free()
        {
            thread = null;

            // release events
            stopEvent.Close();
            stopEvent = null;
        }

        // Stop
        public void PollingStop()
        {
            if (this.Running)
            {
                SignalToStop();
                while (thread.IsAlive)
                {
                    if (WaitHandle.WaitAll(
                        (new ManualResetEvent[] { stopEvent }),
                        100,
                        true))
                    {
                        WaitForStop();
                        break;
                    }

                    Application.DoEvents();
                }
            }
        }

        string _olddispenserstate = "";
        // Worker thread
        public static Dictionary<string, string> GetEventContent(string[] datas)
        {
            Dictionary<string, string> output = new Dictionary<string, string>();
            foreach (string data in datas)
            {
                if (data.Contains("="))
                {
                    string[] subData = data.Split('=');
                    output.Add(subData[0].ToLower().Trim(), subData[1].Trim());
                }
            }
            return output;
        }
        public void WorkerThread()
        {
            while (!stopEvent.WaitOne(0, true))
            {
                try
                {
                    string viewraw = "";
                    string[] message = null;

                    foreach (Controller controller in controllers)
                    {

                        Address = controller.Address;
                        // Thuc hien lenh den thiet bi (pc <-> host)
                        string response = ExecuteCommand(null, "GetEvent?/", ref viewraw, ref message);

                        // Trang thai thiet bij
                        controller.IsConnect = response != "";
                        this.isconnect = response != "";
                        //AccessCardGrant: Char(2) + GetEvent?/Style=Card/UserID=100/LenCard=4/Card=7C19F640/Reader=01/DateTime=YYYYMMDDhhmmss/CardState=U/AccessState=1/Door=00/StateMSG=00 + char(3)
                        //AccessCardDenie: Char(2) + GetEvent?/Style=Card/UserID=Null/LenCard=4/Card=7C19F640/Reader=01/DateTime=YYYYMMDDhhmmss/CardState=U/AccessState=1/Door=00/StateMSG=00 + char(3)
                        //InputEvent     : Char(2) + GetEvent?/Style=input/Input=INPUT1/DateTime=YYYYMMDDhhmmss + char(3)
                        //NoEvent        : Char(2) + GetEvent?/NotEvent + char(3)
                        if (response != "" && (response.Contains("GetEvent?/")) && !response.Contains("NotEvent"))
                        {
                            string[] data = response.Split('/');
                            Dictionary<string, string> map = GetEventContent(data);
                            bool isCardEvent = response.Contains("Card");
                            if (isCardEvent)
                            {
                                CallCardEvent(ref viewraw, ref message, controller, ref response, map);
                            }
                            else
                            {
                                response = CallInputEvent(ref viewraw, ref message, controller, map);
                            }
                        }
                    }
                    Thread.Sleep(300);
                }
                catch (Exception ex)
                {
                    //MessageBox.Show(ex.Message);
                    SystemUI.SaveLogFile("WorkerThread\n" + lineID.ToString() + "\n" + ex.Message);
                }
            }
        }

        private string CallInputEvent(ref string viewraw, ref string[] message, Controller controller, Dictionary<string, string> map)
        {
            string response;
            InputEventArgs ie = new InputEventArgs();

            ie.LineID = controller.LineID;
            ie.LineCode = controller.LineCode;
            ie.ControllerAddress = controller.Address;
            // YYMMDD
            ie.EventDate = DateTime.Now.ToString("yyyy/MM/dd");
            // HHMMSS
            ie.EventTime = DateTime.Now.ToString("HH:mm:ss");
            ie.IsOpenDoor = false;

            string str_time = map.ContainsKey("datetime") ? map["datetime"] : "";
            string str_inputName = map.ContainsKey("input") ? map["input"] : "";
            if (!string.IsNullOrEmpty(str_inputName))
            {
                string str_inputIndex = str_inputName.Replace("INPUT", "");
                ie.Inputport = Regex.IsMatch(str_inputIndex, @"^\d+$") ? str_inputIndex : "-1";
            }
            if (ie.Inputport == "1")
            {
                ie.EventType = "ExitB1";
            }
            else if (ie.Inputport == "2")
            {
                ie.EventType = "ExitB2";
            }
            else if (ie.Inputport == "3")
            {
                ie.EventType = "MSGA";
            }
            else if (ie.Inputport == "4")
            {
                ie.EventType = "MSGB";
            }

            response = ExecuteCommand(null, "DeleteEvent?/", ref viewraw, ref message);
            if (response.Contains("DeleteEvent?/OK"))
            {
                if (InputEvent != null)
                {
                    InputEvent(this, ie);
                }
            }

            return response;
        }

        private void CallCardEvent(ref string viewraw, ref string[] message, Controller controller, ref string response, Dictionary<string, string> map)
        {
            CardEventArgs e = new CardEventArgs();
            e.LineID = controller.LineID;
            e.LineCode = controller.LineCode;
            e.ControllerAddress = controller.Address;
            e.CardNumber = "";
            string cardNumberHEX = map.ContainsKey("card") ? map["card"] : "";
            int _indexcard = response.LastIndexOf("UID=") + "UID=".Length;
            e.CardNumber = cardNumberHEX;
            e.CardNumber = Convert.ToInt64(e.CardNumber, 16).ToString("0000000000");
            string str_readerIndex = map.ContainsKey("reader") ? map["reader"] : "";
            e.ReaderIndex = Regex.IsMatch(str_readerIndex, @"^\d+$") ? Convert.ToInt32(str_readerIndex) : -1;
            string time = map.ContainsKey("datetime") ? map["datetime"] : "";
            e.Date = time.Substring(0, 4) + "/" + time.Substring(4, 2) + "/" + time.Substring(6, 2);
            e.Time = time.Substring(8, 2) + ":" + time.Substring(10, 2) + ":" + time.Substring(12, 2);
            e.ViewRaw = viewraw;
            e.Message = response;
            response = ExecuteCommand(null, "DeleteEvent?/", ref viewraw, ref message);
            if (response.Contains("DeleteEvent?/OK"))
            {
                if (CardEvent != null)
                    CardEvent(this, e);
            }
        }

        #endregion

        #region Method

        // Nhan thong tin thiet bi
        public string GetVersion()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 0x33 - nhan dia chi thiet bi (dat dia chi thiet bi la 000 - 0x30, 0x30, 0x30)
                        byte[] bytes = new byte[] { 0x01, 0x30, 0x30, 0x30, 0x33, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        //bytes[4] = Convert.ToByte(ByteUI.Asc("3"));
                        bytes[15] = ByteUI.CRC(bytes, 16, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "")
                        {
                            return ByteUI.AscToStr(message[1]) + ByteUI.AscToStr(message[2]) + ByteUI.AscToStr(message[3]);
                        }
                    }
                }
                else
                {
                    // UDP: Broadcast
                    // char (2) + AutoDetech?+ char(3) 	
                    // Char(2) +  Futech-FAT3.0/IP=192.168.1.250/Port=5000/SubnetMask=255.255.255.0/ DefaultGateWay=192.168.1.1/MAC=0.24.77.80.25.30+char(3)
                    string tempStr = ExecuteCommand(null, "AutoDetech?", ref viewraw, ref message);
                    if (tempStr != "")
                    {
                        return tempStr;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // Thay doi dia chi thiet bi (MID)
        public bool ChangeAddress(string NewAddress)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        NewAddress = Convert.ToInt32(NewAddress).ToString("000");
                        byte newadd1 = 0x30, newadd2 = 0x30, newadd3 = 0x30;
                        newadd1 = Convert.ToByte(ByteUI.Asc(NewAddress.Substring(0, 1)));
                        newadd2 = Convert.ToByte(ByteUI.Asc(NewAddress.Substring(1, 1)));
                        newadd3 = Convert.ToByte(ByteUI.Asc(NewAddress.Substring(2, 1)));

                        // 0x34 - dat lai dia chi thiet bi
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x34, 0x30, newadd1, newadd2, newadd3, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[15] = ByteUI.CRC(bytes, 16, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[5] == "31")
                        {
                            Address = Convert.ToInt32(NewAddress);
                            return true;
                        }
                    }
                }
                else
                {
                    // Char(2) + “SetID?/ID=125” + char(3)
                    // Char(2) +”SetID=OK”+ char(3)
                    // Char(2) + “SetID=ERROR”+ char(3)
                    string tempStr = ExecuteCommand(null, "SetID?/ID=" + NewAddress, ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        Address = Convert.ToInt32(NewAddress);
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Thay doi dia chi IP
        public bool ChangeIP(string IP, string Port, string SubnetMask, string DefaultGateway)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {

                    }
                }
                else
                {
                    // Char(2) + ChangeIP?/IP=192.168.1.250/Port=5000/SubnetMask=255.255.255.0/DefaultGateWay=192.168.1.1 + char(3)
                    // Char(2) +ChangeIP=OK  + Char(3)
                    // Char(2) +ChangeIP=ERROR + Char(3)
                    string tempStr = ExecuteCommand(null, "ChangeIP?/IP=" + IP + "/Port=" + Port + "/SubnetMask=" + SubnetMask + "/DefaultGateWay=" + DefaultGateway, ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        ComPort = IP;
                        BaudRate = Convert.ToInt32(Port);
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Thay doi ma he thong
        public bool ChangeSysKey(string NewKeyA, string NewKeyB)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        KeyA = NewKeyA;
                        KeyB = NewKeyB;

                        // Thay doi KeyA
                        // 0x35 - thay doi KeyA
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x35, 0x30, keyA1, keyA2, keyA3, keyA4, keyA5, keyA6, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "35")
                        {
                            // Thay doi tiep KeyB
                            // 0x36 - thay doi KeyB
                            bytes = new byte[] { 0x01, add1, add2, add3, 0x36, 0x30, keyB1, keyB2, keyB3, keyB4, keyB5, keyB6, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                            bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                            // Thuc hien lenh den thiet bi (pc <-> host)
                            // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                            if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "36")
                            {
                                {
                                    return true;
                                }
                            }
                        }
                    }
                }
                else
                {
                    // Char(2) + ChangeKeyA?/KeyA=1F2F3F4F5F6F + char(3)
                    // Char(2) +  ChangeKeyA=OK + char(3)	
                    // Char(2) +  ChangeKeyA=ERROR	+ char(3)
                    string tempStr = ExecuteCommand(null, "ChangeKeyA?/KeyA=" + NewKeyA, ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        // Char(2) + ChangeKeyB?/KeyB=1F2F3F4F5F6F + char(3)
                        // Char(2) +  ChangeKeyB=OK + char(3)	
                        // Char(2) +  ChangeKeyB=ERROR	+ char(3)
                        tempStr = ExecuteCommand(null, "ChangeKeyB?/KeyB=" + NewKeyB, ref viewraw, ref message);
                        if (tempStr != "" && tempStr.Contains("OK"))
                        {
                            KeyA = NewKeyA;
                            KeyB = NewKeyB;
                            return true;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Khoi tao mac dinh he thong
        public bool InitDefault()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 31 37 30 30 30 30 30 30 30 30 30 30  AA   
                        // 0x37 - yeu cau khoi tao lai mac dinh he thong
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "37")
                        {
                            return true;
                        }
                    }
                }
                else
                {
                    // Char(2) + ResetDefault?  + char(3)
                    // Char(2) + ResetDefault=OK+ char(3)
                    // Char(2) + ResetDefault=ERROR+ char(3)
                    string tempStr = ExecuteCommand(null, "ResetDefault?", ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Khoi dong lai thiet bi
        public bool Reset()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 31 37 30 30 30 30 30 30 30 30 30 30  AA   
                        // 0x38 - yeu cau khoi dong lai thiet bi
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x38, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "38")
                        {
                            return true;
                        }
                    }
                }
                else
                {
                    // Char(2) + Restart?   + char(3)
                    // Char(2) +”SetID=OK”+ char(3)
                    // Char(2) + “SetID=ERROR”+ char(3)
                    string tempStr = ExecuteCommand(null, "Restart?", ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Nhan dia chi thiet bi
        public string GetMID()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 30 33 30 30 30 30 30 30 30 30 30 30 30 30 30 30 65
                        // 0x33 - nhan dia chi thiet bi
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x33, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "33")
                        {
                            return ByteUI.AscToStr(message[1]) + ByteUI.AscToStr(message[2]) + ByteUI.AscToStr(message[3]);
                        }
                    }
                }
                else
                {

                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // Dat lai dia chi thiet bi
        public bool SetMID(int newMID)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 30 34 30 31 32 35 30 30 30 30 30 30 30 30 30 30 6E   (đặt địa chỉ 125)
                        // 0x34 - dat lai dia chi thiet bi
                        byte add1 = 0x30, add2 = 0x30, add3 = 0x30;
                        add1 = Convert.ToByte(ByteUI.Asc(newMID.ToString("000").Substring(0, 1)));
                        add2 = Convert.ToByte(ByteUI.Asc(newMID.ToString("000").Substring(1, 1)));
                        add3 = Convert.ToByte(ByteUI.Asc(newMID.ToString("000").Substring(2, 1)));

                        byte[] bytes = new byte[] { 0x01, 0x30, 0x30, 0x30, 0x34, 0x30, add1, add2, add3, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "34")
                        {
                            Address = newMID;
                            return true;
                        }
                    }
                }
                else
                {

                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Nhan gia tri thanh toan
        public string GetValue()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 31 3B 30 30 30 30 30 30 30 30 30 30  30 30 30 30 6E   
                        // 0x3B - nhan gia tri thanh toan
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x3B, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "3B")
                        {
                            return ByteUI.AscToStr(message[6]) + ByteUI.AscToStr(message[7]) + ByteUI.AscToStr(message[8]) + ByteUI.AscToStr(message[9]) + ByteUI.AscToStr(message[10]) + ByteUI.AscToStr(message[11]);
                        }
                    }
                }
                else
                {

                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // Thiet lap gia tri thanh toan
        public bool SetValue(int newValue)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 30 3C 30 30 30 31 35 30 30  30 30 30 30 30 30 30  74
                        // 0x3C - thiet lap gia tri thanh toan

                        byte value1 = 0x30, value2 = 0x30, value3 = 0x30, value4 = 0x30, value5 = 0x30, value6 = 0x30;
                        value1 = Convert.ToByte(ByteUI.Asc(newValue.ToString("000000").Substring(0, 1)));
                        value2 = Convert.ToByte(ByteUI.Asc(newValue.ToString("000000").Substring(1, 1)));
                        value3 = Convert.ToByte(ByteUI.Asc(newValue.ToString("000000").Substring(2, 1)));
                        value4 = Convert.ToByte(ByteUI.Asc(newValue.ToString("000000").Substring(3, 1)));
                        value5 = Convert.ToByte(ByteUI.Asc(newValue.ToString("000000").Substring(4, 1)));
                        value6 = Convert.ToByte(ByteUI.Asc(newValue.ToString("000000").Substring(5, 1)));

                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x3C, 0x30, value1, value2, value3, value4, value5, value6, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "3C")
                        {
                            return true;
                        }
                    }
                }
                else
                {

                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // GetDateTime
        public string GetDateTime()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    //year=12/month=02/date=15/hour=20/minute=15/second=30
                    //YYMMDDHHMMSS
                    // 01 30 30 31 39 30 30 30 30 30 30 30 30 30 30  30 30 30 30 6C   
                    if (serialPort.IsOpen)
                    {
                        // 0x39 - nhan thoi gian tu thiet bi
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x39, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00 };
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "39")
                        {
                            return DateTime.Now.ToString("20" + ByteUI.AscToStr(message[6]) + ByteUI.AscToStr(message[7]) + "/" + ByteUI.AscToStr(message[8]) + ByteUI.AscToStr(message[9]) + "/" + ByteUI.AscToStr(message[10]) + ByteUI.AscToStr(message[11])) + " " + DateTime.Now.ToString(ByteUI.AscToStr(message[12]) + ByteUI.AscToStr(message[13]) + ":" + ByteUI.AscToStr(message[14]) + ByteUI.AscToStr(message[15]) + ":" + ByteUI.AscToStr(message[16]) + ByteUI.AscToStr(message[17]));
                        }
                    }
                }
                else
                {
                    // Char(2) +  GetDateTime?/(sum+1)+ char(3)
                    string tempStr = ExecuteCommand(null, "GetDateTime?/", ref viewraw, ref message);
                    if (tempStr != "")
                    {
                        return "20" + tempStr.Substring(0, 2) + "/" + tempStr.Substring(2, 2) + "/" + tempStr.Substring(4, 2) + " " +
                            tempStr.Substring(6, 2) + ":" + tempStr.Substring(8, 2) + ":" + tempStr.Substring(10, 2);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // SetDateTime
        public bool SetDateTime(string strDateTime)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {
                        // 01 30 30 31 3A 30 31 32 30 36 32 38 31 38 30  37 30 35 30 95   
                        // 0x3A - dat lai thoi gian
                        byte[] bytes = new byte[] { 0x01, add1, add2, add3, 0x3A, 0x30,
                        Convert.ToByte(ByteUI.Asc(strDateTime.Substring(0, 1))), Convert.ToByte(ByteUI.Asc(strDateTime.Substring(1, 1))),
                        Convert.ToByte(ByteUI.Asc(strDateTime.Substring(2,1))), Convert.ToByte(ByteUI.Asc(strDateTime.Substring(3,1))),
                        Convert.ToByte(ByteUI.Asc(strDateTime.Substring(4,1))), Convert.ToByte(ByteUI.Asc(strDateTime.Substring(5,1))),
                        Convert.ToByte(ByteUI.Asc(strDateTime.Substring(6,1))), Convert.ToByte(ByteUI.Asc(strDateTime.Substring(7,1))),
                        Convert.ToByte(ByteUI.Asc(strDateTime.Substring(8,1))), Convert.ToByte(ByteUI.Asc(strDateTime.Substring(9,1))),
                        Convert.ToByte(ByteUI.Asc(strDateTime.Substring(10,1))), Convert.ToByte(ByteUI.Asc(strDateTime.Substring(11,1))), 0x30, 0x00};
                        bytes[bytes.Length - 1] = ByteUI.CRC(bytes, 20, 1);

                        // Thuc hien lenh den thiet bi (pc <-> host)
                        // State = 0x31 - thanh cong, 0x32 - khong thanh cong
                        if (ExecuteCommand(bytes, "", ref viewraw, ref message) != "" && message[4] == "3A")
                        {
                            return true;
                        }
                    }
                }
                else
                {
                    // Char(2) + SetDateTime?/year=12/month=02/date=19/hour=22/minute=44/second=00/(sum+1)+ char(3)
                    // YYMMDDHHMMSS
                    string tempStr = ExecuteCommand(null, "SetDateTime?/" + strDateTime, ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        // Tim thiet bi
        public string[] Broadcast()
        {
            try
            {
                string viewraw = "";
                string[] message = new string[1000];
                // UDP: Broadcast
                // AutoDetect?	
                // Char(2) +  Futech-FAT3.0/IP=192.168.1.250/Port=5000/SubnetMask=255.255.255.0/ DefaultGateWay=192.168.1.1/MAC=0.24.77.80.25.30+char(3)
                string command = "AutoDetect?";
                UdpClient m_UdpClient = new UdpClient();
                IPEndPoint m_IPEndPoint = new IPEndPoint(IPAddress.Broadcast, 65535);
                byte[] byteSend = System.Text.Encoding.ASCII.GetBytes(command);
                m_UdpClient.Send(byteSend, byteSend.Length, m_IPEndPoint);

                Thread.Sleep(200);

                int i = 0;
                while (true)
                {
                    if (m_UdpClient.Available > 0)
                    {
                        byte[] byteReceive = m_UdpClient.Receive(ref m_IPEndPoint);
                        viewraw = System.Text.Encoding.UTF8.GetString(byteReceive);
                        message[i] = i + 1 + "/" + viewraw.Substring(1, viewraw.Length - 2);
                        i = i + 1;
                        Thread.Sleep(10);
                        Application.DoEvents();
                    }
                    else
                        break;
                }
                return message;
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return null;
        }

        // GetLastID
        public string GetLastEventID()
        {
            //try
            //{
            //    string viewraw = "";
            //    string[] message = null;
            //    if (CommunicationType == 0)
            //    {
            //        if (serialPort.IsOpen)
            //        {

            //        }
            //    }
            //    else
            //    {
            //        // Char(2) +  GetLastID?/(sum+1) + char(3)
            //        // ( ID= 00001->04500)
            //        string tempStr = ExecuteCommand(null, "GetLastID?", ref viewraw, ref message);
            //        if (tempStr != "" && tempStr.Length >= 5)
            //        {
            //            return tempStr.Substring(0, 5);
            //        }
            //    }
            //}
            //catch (Exception ex)
            //{
            //    MessageBox.Show(ex.Message);
            //}
            return "";
        }

        // GetEvent&ID
        // Khoi phuc lai du lieu
        public string GetEventByID(string ID, ref CardEventArgs e, bool IsSave)
        {
            //try
            //{
            //    string viewraw = "";
            //    string[] message = null;
            //    if (CommunicationType == 0)
            //    {
            //        if (serialPort.IsOpen)
            //        {

            //        }
            //    }
            //    else
            //    {
            //        // Char(2) +  GetEvent&ID?/ID=00635/(sum+1) + char(3)
            //        // ( ID= 00001->04500)
            //        foreach (Futech.Objects.Controller controller in controllers)
            //        {
            //            Address = controller.Address;
            //            // Thuc hien lenh den thiet bi (pc <-> host)
            //            string tempStr = ExecuteCommand(null, "GetEvent&ID?/ID=" + ID, ref viewraw, ref message);

            //            // Trang thai thiet bij
            //            if (tempStr != "")
            //                controller.IsConnect = true;
            //            else
            //                controller.IsConnect = false;

            //            if (CardEvent != null)
            //            {
            //                string temp = tempStr;
            //            }

            //            if (CardEvent != null && tempStr != "" && (tempStr.Contains("N") || tempStr.Contains("Y")) && !tempStr.Contains("NotEvent") && message[0] == "02")
            //            {
            //                e = new CardEventArgs();
            //                e.LineID = controller.LineID;
            //                e.LineCode = controller.LineCode;
            //                e.ControllerAddress = controller.Address;
            //                e.CardNumber = "";
            //                int i = 0;

            //                for (i = 1; i <= 10; i++)
            //                    e.CardNumber += ByteUI.AscToStr(message[i]);
            //                e.CardNumber = Convert.ToInt64(e.CardNumber).ToString("X");

            //                // YYMMDD
            //                e.Date = DateTime.Now.ToString("yyyy/MM/dd");
            //                string tempDate = "20";
            //                for (i = 28; i <= 33; i++)
            //                    tempDate += ByteUI.AscToStr(message[i]);
            //                if (tempDate.Length == 8)
            //                {
            //                    tempDate = tempDate.Substring(0, 4) + "/" + tempDate.Substring(4, 2) + "/" + tempDate.Substring(6, 2);
            //                    e.Date = tempDate;
            //                }

            //                // HHMMSS
            //                e.Time = DateTime.Now.ToString("HH:mm:ss");
            //                string tempTime = "";
            //                for (i = 34; i <= 39; i++)
            //                    tempTime += ByteUI.AscToStr(message[i]);
            //                if (tempTime.Length == 6)
            //                {
            //                    tempTime = tempTime.Substring(0, 2) + ":" + tempTime.Substring(2, 2) + ":" + tempTime.Substring(4, 2);
            //                    e.Time = tempTime;
            //                }

            //                string tempValue1 = "0";
            //                for (i = 12; i <= 19; i++)
            //                    tempValue1 += ByteUI.AscToStr(message[i]);
            //                e.Value1 = Convert.ToInt32(tempValue1);

            //                string tempBalance = "0";
            //                for (i = 20; i <= 27; i++)
            //                    tempBalance += ByteUI.AscToStr(message[i]);
            //                e.Balance = Convert.ToInt32(tempBalance);

            //                e.Desc = "Thanh toan bang dau doc the FAT810W";

            //                if (message[11] == "2D")
            //                {
            //                    e.Action = "DEC";
            //                    e.EventCode = "03";
            //                }
            //                else
            //                {
            //                    e.Action = "INC";
            //                    e.EventCode = "03";
            //                }

            //                e.ViewRaw = viewraw;
            //                e.Message = tempStr;

            //                for (i = 41; i <= 45; i++)
            //                {
            //                    e.EventID += ByteUI.AscToStr(message[i]);
            //                }
            //                //CardEvent(this, e);

            //                if (e.Value1 < 1000000 && IsSave)
            //                {
            //                    e.IsRecoverEvent = true;
            //                    CardEvent(this, e);
            //                }
            //            }
            //        }
            //    }
            //}
            //catch (Exception ex)
            //{
            //    MessageBox.Show(ex.Message);
            //}
            return "";
        }

        // SaveBlackList
        public bool SaveBlackList(string ID, string strCardNumber)
        {
            //try
            //{
            //    string viewraw = "";
            //    string[] message = null;
            //    if (CommunicationType == 0)
            //    {
            //        if (serialPort.IsOpen)
            //        {

            //        }
            //    }
            //    else
            //    {
            //        // Char(2) +SaveBlackList?/ID=00001/ UID=2026983332/(sum+1)+ char(3)
            //        // ( ID= 00000->00999)
            //        uint szCardID = uint.Parse(strCardNumber, System.Globalization.NumberStyles.HexNumber);
            //        string tempStr = ExecuteCommand(null, "SaveBlackList?/ID=" + ID + "/ UID=" + szCardID, ref viewraw, ref message);
            //        if (tempStr != "" && tempStr.Contains("OK"))
            //        {
            //            return true;
            //        }
            //    }
            //}
            //catch (Exception ex)
            //{
            //    MessageBox.Show(ex.Message);
            //}
            return false;
        }

        // GetBlackList
        public string GetBlackList(string ID)
        {
            //try
            //{
            //    string viewraw = "";
            //    string[] message = null;
            //    if (CommunicationType == 0)
            //    {
            //        if (serialPort.IsOpen)
            //        {

            //        }
            //    }
            //    else
            //    {
            //        // Char(2) + GetBlackList?/ID=00001/(sum+1)+ char(3)
            //        // ( ID= 00000->00999)
            //        string tempStr = ExecuteCommand(null, "GetBlackList?/ID=" + ID, ref viewraw, ref message);
            //        if (tempStr != "" && !tempStr.Contains("NotCard"))
            //        {
            //            string szCardID = Convert.ToInt64(tempStr.Substring(0, 10)).ToString("X");
            //            return szCardID;
            //        }
            //        else if (tempStr != "" && tempStr.Contains("NotCard"))
            //            return "-1";
            //    }
            //}
            //catch (Exception ex)
            //{
            //    MessageBox.Show(ex.Message);
            //}
            return "";
        }

        // DeleteBlackList
        public bool DeleteBlackList(string ID)
        {
        //    try
        //    {
        //        string viewraw = "";
        //        string[] message = null;
        //        if (CommunicationType == 0)
        //        {
        //            if (serialPort.IsOpen)
        //            {

        //            }
        //        }
        //        else
        //        {
        //            // Char(2) + DeleteBlackList?/ID=00001/(sum+1)+ char(3)
        //            // ( ID= 00000->00999)
        //            string tempStr = ExecuteCommand(null, "DeleteBlackList?/ID=" + ID, ref viewraw, ref message);
        //            if (tempStr != "" && tempStr.Contains("OK"))
        //            {
        //                return true;
        //            }
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        MessageBox.Show(ex.Message);
        //    }
            return false;
        }

        //// DeleteAllBlackList
        public bool DeleteAllBlackList()
        {
        //    try
        //    {
        //        string viewraw = "";
        //        string[] message = null;
        //        if (CommunicationType == 0)
        //        {
        //            if (serialPort.IsOpen)
        //            {

        //            }
        //        }
        //        else
        //        {
        //            // Char(2) + DeleteAllBlackList?/(sum+1) + char(3)
        //            // ( ID= 00000->00999)
        //            string tempStr = ExecuteCommand(null, "DeleteAllBlackList?", ref viewraw, ref message);
        //            if (tempStr != "" && tempStr.Contains("OK"))
        //            {
        //                return true;
        //            }
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        MessageBox.Show(ex.Message);
        //    }
            return false;
        }

        // 18.	GetSystemCode?
        public string GetSystemCode()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {

                    }
                }
                else
                {
                    // Char(2) +  GetSystemCode?/( sum+1)+ char(3)
                    string tempStr = ExecuteCommand(null, "GetSystemCode?", ref viewraw, ref message);
                    if (tempStr != "")
                    {
                        return tempStr.Substring(0, 8);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        // 17.	SetSystemCode
        public bool SetSystemCode(string strSystemCode)
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {

                    }
                }
                else
                {
                    // Char(2) + SetSystemCode?/ 17051983 /(sum+1)+ char(3)
                    string tempStr = ExecuteCommand(null, "SetSystemCode?/" + strSystemCode, ref viewraw, ref message);
                    if (tempStr != "" && tempStr.Contains("OK"))
                    {
                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return false;
        }

        public void OpenDoor(int relay)
        {
            string viewraw = "";
            string[] message = null;
            string strCommand = "SetRelay?/Relay=" + relay.ToString("00") + "/State=ON";
            string tempStr = ExecuteCommand(null, strCommand, ref viewraw, ref message);
        }

        public void OpenRelay(int relay, int delay)
        {
            string viewraw = "";
            string[] message = null;
            string strCommand = $"SetRelay?/Relay={relay:00}/State=ON";
            string tempStr = ExecuteCommand(null, strCommand, ref viewraw, ref message);
        }

        public string GetInputState()
        {
            try
            {
                string viewraw = "";
                string[] message = null;
                if (CommunicationType == 0)
                {
                    if (serialPort.IsOpen)
                    {

                    }
                }
                else
                {
                    // Char(2) +  GetInputState?/( sum+1)+ char(3)
                    string tempStr = ExecuteCommand(null, "GetInputState?", ref viewraw, ref message);
                    if (tempStr != "")
                    {
                        return tempStr.Substring(tempStr.Length - 2);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            return "";
        }

        /*      public void DeleteEvnet()
              {
                  string viewraw = "";
                  string[] message = null;
                  string strCommand = "DeleteEvent?/";
                  string tempStr = ExecuteCommand(null, strCommand, ref viewraw, ref message);
              }*/
        #endregion
    }
}